<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.513">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SpaDES For Dummies - 1&nbsp; Introducing SpaDES with a dummy ecological model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Part2_SDMs.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="css/style.css">
<meta name="twitter:title" content="SpaDES For Dummies - 1&nbsp; Introducing SpaDES with a dummy ecological model">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">SpaDES For Dummies</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/CeresBarros/SpaDES4Dummies"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools tools-wide">
    <a href="./SpaDES-For-Dummies.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Part1_DummyModel.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducing `SpaDES` with a dummy ecological model</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Part1_DummyModel.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducing <code>SpaDES</code> with a dummy ecological model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Part2_SDMs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A more realistic example of <code>SpaDES</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./References.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendices/Part1_Rscript.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Complete R script to Chapter 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendices/Part2_Rscript.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Complete R script to Chapter 2</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#before-spades" id="toc-before-spades" class="nav-link active" data-scroll-target="#before-spades"><span class="header-section-number">1.1</span> BEFORE <code>SpaDES</code></a>
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">1.1.1</span> Setup</a></li>
  <li><a href="#species-abundance-simulations" id="toc-species-abundance-simulations" class="nav-link" data-scroll-target="#species-abundance-simulations"><span class="header-section-number">1.1.2</span> Species abundance “simulations”</a></li>
  <li><a href="#temperature-simulations" id="toc-temperature-simulations" class="nav-link" data-scroll-target="#temperature-simulations"><span class="header-section-number">1.1.3</span> Temperature “simulations”</a></li>
  <li><a href="#data-analysis" id="toc-data-analysis" class="nav-link" data-scroll-target="#data-analysis"><span class="header-section-number">1.1.4</span> Data analysis</a></li>
  </ul></li>
  <li><a href="#after-spades" id="toc-after-spades" class="nav-link" data-scroll-target="#after-spades"><span class="header-section-number">1.2</span> AFTER <code>SpaDES</code></a>
  <ul>
  <li><a href="#the-control-script" id="toc-the-control-script" class="nav-link" data-scroll-target="#the-control-script"><span class="header-section-number">1.2.1</span> The control script</a></li>
  <li><a href="#general-module-structure-speciesabundance-module" id="toc-general-module-structure-speciesabundance-module" class="nav-link" data-scroll-target="#general-module-structure-speciesabundance-module"><span class="header-section-number">1.2.2</span> General module structure: <em>speciesAbundance</em> module</a>
  <ul class="collapse">
  <li><a href="#defining-the-module" id="toc-defining-the-module" class="nav-link" data-scroll-target="#defining-the-module"><span class="header-section-number">1.2.2.1</span> <strong>Defining the module</strong></a></li>
  <li><a href="#events-and-event-functions" id="toc-events-and-event-functions" class="nav-link" data-scroll-target="#events-and-event-functions"><span class="header-section-number">1.2.2.2</span> <strong>Events and event functions</strong></a></li>
  <li><a href="#scheduling-events" id="toc-scheduling-events" class="nav-link" data-scroll-target="#scheduling-events"><span class="header-section-number">1.2.2.3</span> <strong>Scheduling events</strong></a></li>
  <li><a href="#inputobjects-function" id="toc-inputobjects-function" class="nav-link" data-scroll-target="#inputobjects-function"><span class="header-section-number">1.2.2.4</span> <strong><code>.inputObjects</code> function</strong></a></li>
  <li><a href="#additional-module-functions" id="toc-additional-module-functions" class="nav-link" data-scroll-target="#additional-module-functions"><span class="header-section-number">1.2.2.5</span> <strong>Additional module functions</strong></a></li>
  </ul></li>
  <li><a href="#creating-and-adding-additional-modules-the-temperature-module" id="toc-creating-and-adding-additional-modules-the-temperature-module" class="nav-link" data-scroll-target="#creating-and-adding-additional-modules-the-temperature-module"><span class="header-section-number">1.2.3</span> Creating and adding additional modules: the <em>temperature</em> module</a></li>
  <li><a href="#modules-that-depend-on-other-modules-the-speciestemplm-module" id="toc-modules-that-depend-on-other-modules-the-speciestemplm-module" class="nav-link" data-scroll-target="#modules-that-depend-on-other-modules-the-speciestemplm-module"><span class="header-section-number">1.2.4</span> Modules that depend on other modules: the <em>speciesTempLM</em> module</a></li>
  <li><a href="#simulation" id="toc-simulation" class="nav-link" data-scroll-target="#simulation"><span class="header-section-number">1.2.5</span> Simulation</a>
  <ul class="collapse">
  <li><a href="#simulation-setup-in-a-global-script" id="toc-simulation-setup-in-a-global-script" class="nav-link" data-scroll-target="#simulation-setup-in-a-global-script"><span class="header-section-number">1.2.5.1</span> Simulation setup in a “global” script</a></li>
  <li><a href="#checking-the-simulation-setup" id="toc-checking-the-simulation-setup" class="nav-link" data-scroll-target="#checking-the-simulation-setup"><span class="header-section-number">1.2.5.2</span> Checking the simulation setup</a></li>
  <li><a href="#running-spades" id="toc-running-spades" class="nav-link" data-scroll-target="#running-spades"><span class="header-section-number">1.2.5.3</span> Running <code>SpaDES</code></a></li>
  </ul></li>
  <li><a href="#additional-notes" id="toc-additional-notes" class="nav-link" data-scroll-target="#additional-notes"><span class="header-section-number">1.2.6</span> Additional notes</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-part1" class="quarto-section-identifier"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducing <code>SpaDES</code> with a dummy ecological model</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Authors: Ceres Barros, Tati Micheletti</p>
<p>Let’s imagine we want to explore how the relationship between a species’ abundance and temperature changes over time. Both the abundance data and the temperature data are being constantly updated by a simulation model, and we want to analyse the relationship between the two iteratively, without needing to manually run a script to account for the newly generated data inputs.</p>
<section id="before-spades" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="before-spades"><span class="header-section-number">1.1</span> BEFORE <code>SpaDES</code></h2>
<p>If we use R to develop our species abundance and temperature simulation models in the ‘conventional way’, we’ll probably have i) (the worst case scenario) several scripts that run simulations and data treatment/analysis separately and have to be executed manually, or ii) a long script where everything happens - the simulations and data analysis -, iii) a main script that sources others that do the simulation and analyses. Option i) is more common when different software are used for different parts of the process (e.g., a simulation model in <em>C++</em> generates data that is then analysed in R). Option ii) is inconvenient because very long scripts make changes and updates to the script - debugging can also be more tiresome. Option iii), is similar to the <code>SpaDES</code> way of thinking. The difference is that <code>SpaDES</code> defines a standard way of writing different components of a model, or of a modelling framework. This makes changing, updating and sharing code - or modules - easier, as well as swapping and adding modules in a modelling framework.</p>
<p>The example below is so minimal that it is unlikely to show the full benefits of using <code>SpaDES</code> - the same could be accomplished with a fairly short script. However, it introduces the different parts of a module and how to link modules.</p>
<p><a href="./Part2_SDMs.html">Chapter 2</a> goes a step further and uses real datasets to project species presences across a landscape in Canada. In <a href="./Part2_SDMs.html">Chapter 2</a>, we introduce <code>SpaDES</code> features that we most commonly use in our work (e.g., caching and spatial data processing) and provide some coding best practices that we use ourselves (e.g., code assertions).</p>
<section id="setup" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="setup"><span class="header-section-number">1.1.1</span> Setup</h3>
<p>This is what you’d normally do… Install all the packages in some way that you probably didn’t record in your scripts and then start your script with loading the packages:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r fold-show code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## please start from a clean R session</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"ropensci/NLMR"</span>)  <span class="do">## you will need this ;)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quickPlot)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And now create a raster template:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r fold-show code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="at">nrows =</span> <span class="dv">100</span>, <span class="at">ncols =</span> <span class="dv">100</span>, <span class="at">xmin =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">xmax =</span> <span class="dv">50</span>, <span class="at">ymin =</span> <span class="sc">-</span><span class="dv">50</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymax =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="species-abundance-simulations" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="species-abundance-simulations"><span class="header-section-number">1.1.2</span> Species abundance “simulations”</h3>
<p>Our VERY simple “simulation” model (in form of a function) generates rasters that follow a Gaussian distribution</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r fold-show code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>abundance_model <span class="ot">&lt;-</span> <span class="cf">function</span>(ras, Time) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    abund_outputs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Time) {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        abund_outputs[[t]] <span class="ot">&lt;-</span> NLMR<span class="sc">::</span><span class="fu">nlm_mpd</span>(<span class="at">ncol =</span> <span class="fu">ncol</span>(ras),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">nrow =</span> <span class="fu">nrow</span>(ras), <span class="at">resolution =</span> <span class="fu">unique</span>(<span class="fu">res</span>(ras)),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">roughness =</span> <span class="fl">0.5</span>, <span class="at">rand_dev =</span> <span class="dv">100</span>, <span class="at">rescale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">verbose =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rast</span>()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(abund_outputs)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Set the length of the simulation (or simply the number of model iterations), run it and plot results (all ABUNDANCE plots together):</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r fold-show code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>Time <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>abundance <span class="ot">&lt;-</span> <span class="fu">abundance_model</span>(<span class="at">ras =</span> r, <span class="at">Time =</span> Time)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dev</span>()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rast</span>(abundance))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Part1_DummyModel_files/figure-html/the_r_way_simulation_length-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="temperature-simulations" class="level3" data-number="1.1.3">
<h3 data-number="1.1.3" class="anchored" data-anchor-id="temperature-simulations"><span class="header-section-number">1.1.3</span> Temperature “simulations”</h3>
<p>The temperature simulation model will be similar to the vegetation one - remember this is a dummy example.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r fold-show code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>temperature_model <span class="ot">&lt;-</span> <span class="cf">function</span>(ras, Time) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    temp_outputs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Time) {</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        temp_outputs[[t]] <span class="ot">&lt;-</span> NLMR<span class="sc">::</span><span class="fu">nlm_mpd</span>(<span class="at">ncol =</span> <span class="fu">ncol</span>(ras),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">nrow =</span> <span class="fu">nrow</span>(ras), <span class="at">resolution =</span> <span class="fu">unique</span>(<span class="fu">res</span>(ras)),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">roughness =</span> <span class="fl">0.5</span>, <span class="at">rand_dev =</span> <span class="dv">10</span>, <span class="at">rescale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">verbose =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rast</span>()</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(temp_outputs)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Run the model and plot results (all temperature plots together)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r fold-show code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>temperature <span class="ot">&lt;-</span> <span class="fu">temperature_model</span>(<span class="at">ras =</span> r, <span class="at">Time =</span> Time)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rast</span>(temperature))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Part1_DummyModel_files/figure-html/the_r_way_plot_results_TMP-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="data-analysis" class="level3" data-number="1.1.4">
<h3 data-number="1.1.4" class="anchored" data-anchor-id="data-analysis"><span class="header-section-number">1.1.4</span> Data analysis</h3>
<p>Now we analyse if species abundance and temperature are correlated.<br>
</p>
<p>First, we create the data analysis function (a simple linear model):</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r fold-show code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>stats_analysis <span class="ot">&lt;-</span> <span class="cf">function</span>(Data) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"abund"</span>, <span class="st">"temp"</span>) <span class="sc">%in%</span> <span class="fu">colnames</span>(Data))) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(abund <span class="sc">~</span> temp, <span class="at">data =</span> Data)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(Data) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> temp, <span class="at">y =</span> abund)) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_abline</span>(<span class="at">intercept =</span> lm1<span class="sc">$</span>coefficients[<span class="st">"(Intercept)"</span>],</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">slope =</span> lm1<span class="sc">$</span>coefficients[<span class="st">"temp"</span>], <span class="at">size =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Temp."</span>, <span class="at">y =</span> <span class="st">"Species abundance"</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"Data must contain 'abund' and 'temp' columns"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then we create a loop to analyse each plot of our time-series:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r fold-show code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>lmPlots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Time) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    outputdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">abund =</span> <span class="fu">as.vector</span>(abundance[[t]][]),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">temp =</span> <span class="fu">as.vector</span>(temperature[[t]][]))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    lmPlots[[t]] <span class="ot">&lt;-</span> <span class="fu">stats_analysis</span>(<span class="at">Data =</span> outputdata)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Warning: Using `size` aesthetic for lines was deprecated in ggplot2</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.4.0.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="do">## ℹ Please use `linewidth` instead.</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> lmPlots)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Part1_DummyModel_files/figure-html/data_analysis-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="after-spades" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="after-spades"><span class="header-section-number">1.2</span> AFTER <code>SpaDES</code></h2>
<section id="the-control-script" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="the-control-script"><span class="header-section-number">1.2.1</span> The control script</h3>
<p>Let us now solve the same problem using the <code>SpaDES</code> approach.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> We start by creating an <em>.R</em> script (it can have any name) that sets up and runs the <code>SpaDES</code> model. The control script for this example is located on the root of the <em>SpaDES4Dummies</em> GitHub repository under the name <code>Part1_DummyModel.R</code>. Note that Markdown (<code>.Rmd</code>) scripts can also be used instead of `.R` scripts.</p>
<p>We start by making sure all <code>SpaDES</code> packages and their dependencies are installed (and that the installation is <em>scripted</em>) using the <code>Require</code> package.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## start again from a clean R session</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">c</span>(<span class="st">"https://predictiveecology.r-universe.dev/"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">CRAN =</span> <span class="st">"https://cloud.r-project.org"</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="do">## decide where you're working</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>mainPath <span class="ot">&lt;-</span> <span class="st">"~/SpaDES4Dummies_Part1"</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>pkgPath <span class="ot">&lt;-</span> <span class="fu">file.path</span>(mainPath, <span class="st">"packages"</span>, version<span class="sc">$</span>platform,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(version<span class="sc">$</span>major, <span class="st">"."</span>, <span class="fu">strsplit</span>(version<span class="sc">$</span>minor, <span class="st">"[.]"</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>]))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(pkgPath, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="fu">.libPaths</span>(pkgPath, <span class="at">include.site =</span> <span class="cn">FALSE</span>)  <span class="do">## install packages in project library (proj-lib)</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"remotes"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>(<span class="at">lib.loc =</span> pkgPath)) <span class="fu">install.packages</span>(<span class="st">"remotes"</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"Require"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>(<span class="at">lib.loc =</span> pkgPath) <span class="sc">||</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">packageVersion</span>(<span class="st">"Require"</span>, <span class="at">lib.loc =</span> pkgPath) <span class="sc">&lt;</span> <span class="st">"0.3.1.9015"</span>) {</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"PredictiveEcology/Require@2788b023ad191c29346ef8c64df71b937be307e2"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">upgrade =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>Require<span class="sc">::</span><span class="fu">Require</span>(<span class="fu">c</span>(<span class="st">"SpaDES"</span>, <span class="st">"DiagrammeR"</span>), <span class="at">require =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">upgrade =</span> <span class="cn">FALSE</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>, <span class="at">standAlone =</span> <span class="cn">TRUE</span>)  <span class="do">## automatically downloads all packages in the SpaDES family and their dependencies</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SpaDES)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="fu">setPaths</span>(<span class="at">cachePath =</span> <span class="fu">file.path</span>(mainPath, <span class="st">"cache"</span>), <span class="at">inputPath =</span> <span class="fu">file.path</span>(mainPath,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"inputs"</span>), <span class="at">modulePath =</span> <span class="fu">file.path</span>(mainPath, <span class="st">"modules"</span>), <span class="at">outputPath =</span> <span class="fu">file.path</span>(mainPath,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"outputs"</span>))</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="fu">getPaths</span>()  <span class="do">## check that this is what you wanted</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="do">## Let's create a self-contained module that will simulate</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="do">## the species' abundance for any given period of time and</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="do">## frequency.</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(<span class="fu">getPaths</span>()<span class="sc">$</span>modulePath, <span class="st">"speciesAbundance"</span>))) {</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">newModule</span>(<span class="at">name =</span> <span class="st">"speciesAbundance"</span>, <span class="at">path =</span> <span class="fu">getPaths</span>()<span class="sc">$</span>modulePath)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then create modules using <code>newModule</code>. <code>newModule</code> creates a module folder (<em>speciesAbundance</em>) inside <code>/modules</code> that contains both the module <code>.R</code> script template, as well as the documentation template (the <code>.Rmd</code> file). Although we will not be discussing the <code>.Rmd</code> file, please bear in mind that this is a <strong>fundamental</strong> part of creating a reproducible and transparent module - check out the <a href="https://www.britishecologicalsociety.org/wp-content/uploads/2017/12/guide-to-reproducible-code.pdf">Guide to Reproducible Code in Ecology and Evolution</a> from the British Ecological Society). The documentation should contain a the description of the module, its input, parameters and outputs, and potentially a reproducible examples of how the module is executed.</p>
<p><code>newModule</code> also created the folder <code>/data</code> where data necessary to the module can be put in, and the folder <code>/tests</code> that may contain testing scripts. We will not be using either of them in this example.</p>
<p><strong>/!\ ATTENTION /!\</strong></p>
<p><em><code>newModule</code> should only be run once, otherwise it will replace all edits and contents of the module folder with the templates - this is why it is wrapped in an <code>if</code> statement above.</em></p>
<p>Now go ahead, open the <code>speciesAbundance.R</code> script and have a look at it.</p>
<hr>
</section>
<section id="general-module-structure-speciesabundance-module" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="general-module-structure-speciesabundance-module"><span class="header-section-number">1.2.2</span> General module structure: <em>speciesAbundance</em> module</h3>
<p>The module template contains all the essential components of a module, with examples, and may seem overwhelming at first. We’ll go through it step by step (although not necessarily following the order of the script). The module script can be divided into 4 parts:</p>
<p><a href="#defining-the-module"><strong>Defining the module</strong></a>: this is where the module is <strong>defined</strong>, i.e., the module’s metadata (e.g.&nbsp;module author(s), time units, basic parameters, general inputs and outputs, etc.);</p>
<p><a href="#events-and-event-functions"><strong>Events and event functions</strong></a>: these are the “actions” (or events) executed in the module (i.e.&nbsp;species reproduction, plotting, saving parameters) - simply put, <strong>WHAT</strong> the module does;</p>
<p><a href="#scheduling-events"><strong>Scheduling events</strong></a>: this is how <code>SpaDES</code> schedules when each event is going to happen - in which order (e.g.&nbsp;during the simulation, when will <code>SpaDES</code> plot a graph) - simply put, <strong>WHEN</strong> the module does it;</p>
<p><a href="#additional-module-functions"><strong>Additional module functions</strong></a>: any additional functions needed (e.g.&nbsp;this is used to keep the coding of your module as clear and straightforward as possible);</p>
<p>The first thing to note is that <strong>the user does not need to manually run</strong> any of the code inside a module’s <code>.R</code> script. The function <code>simInit()</code> will do so when it sets up the simulation. We will see this see this later in detail.</p>
<section id="defining-the-module" class="level4" data-number="1.2.2.1">
<h4 data-number="1.2.2.1" class="anchored" data-anchor-id="defining-the-module"><span class="header-section-number">1.2.2.1</span> <strong>Defining the module</strong></h4>
<p>The first section of the script defines the module’s <a href="https://data-informed.com/what-is-metadata-a-simple-guide-to-what-everyone-should-know/">metadata</a>. It allows defining the module’s author, keywords, any required packages and module(s) and their versions, but also parameters (and their default values) and input objects that the module requires, and the output objects it creates.</p>
<p>Although this dummy module example requires no true input data, we will define the template raster `r` as an “input” in the <code>expectsInput</code> function, and provide a default object in <code>.inputObjects</code> (see below). As for the outputs, it produces a list of abundance rasters (produced during the <code>abundanceSim</code> event). So we define it as an output in the<code>createsOutput</code> function.</p>
<p>Note that we removed several parameters that come with the template created by the <code>newModule</code> function, as they are not needed for this example.</p>
<p>To distinguish what input and output objects are in the context of a module, a good rule of thumb is that inputs are all the <code>sim$...</code> objects that appear for the first time (in the module events) on the <strong>right-hand side</strong> of a <code>&lt;-</code>, whereas output parameters are the <code>sim$...</code> objects that appear for the first time to the <strong>left-hand side</strong> of a <code>&lt;-</code>. Another way of explaining it for objects is illustrated in <a href="#fig-inOutObj" class="quarto-xref">Figure&nbsp;<span>1.1</span></a> :</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-inOutObj" class="quarto-figure quarto-figure-center anchored" width="80%" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-inOutObj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./home/runner/work/SpaDES4Dummies/SpaDES4Dummies/figures/obj.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-inOutObj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.1: Inputs and outputs in SpaDES: Object A comes from outside of the module (e.g.&nbsp;from an internet URL, from data you have, or from <code>.inputObjects</code>), while Module Z produces object C. Both objects serve as an inputs for Module Y, which in return produce as outputs objects B and D, respectivelly from objects A and C. As Module Z uses a simple function <em>internally</em> to create object C, it doesn’t have any inputs, such as our dummy example.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The default input objects created by the <code>.inputObjects</code> function (see [.inputObjects function]) during the <code>simInit</code> call are exceptions to this rule.</p>
<p>Here is how we defined the <em>speciesAbundance</em> module:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">defineModule</span>(sim, <span class="fu">list</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"speciesAbundance"</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">description =</span> <span class="st">""</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">keywords =</span> <span class="st">""</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">authors =</span> <span class="fu">person</span>(<span class="st">"Me"</span>, <span class="at">email =</span> <span class="st">"me@example.com"</span>, <span class="at">role =</span> <span class="fu">c</span>(<span class="st">"aut"</span>, <span class="st">"cre"</span>)),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">childModules =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">version =</span> <span class="fu">list</span>(<span class="at">speciesAbundanceData =</span> <span class="st">"1.0.0"</span>),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeframe =</span> <span class="fu">as.POSIXlt</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>)),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeunit =</span> <span class="st">"year"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">citation =</span> <span class="fu">list</span>(<span class="st">"citation.bib"</span>),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">documentation =</span> <span class="fu">deparse</span>(<span class="fu">list</span>(<span class="st">"README.txt"</span>, <span class="st">"speciesAbundance.Rmd"</span>)),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">reqdPkgs =</span> <span class="fu">list</span>(<span class="st">"SpaDES.core (&gt;=2.0.2)"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"terra"</span>, <span class="st">"quickPlot"</span>),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">parameters =</span> <span class="fu">bindrows</span>(</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#defineParameter("paramName", "paramClass", value, min, max, "parameter description"),</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">defineParameter</span>(<span class="st">"simulationTimeStep"</span>, <span class="st">"numeric"</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"This describes the simulation time step interval"</span>),</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">defineParameter</span>(<span class="st">".plotInitialTime"</span>, <span class="st">"numeric"</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Describes the simulation time at which the first plot event should occur."</span>),</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">defineParameter</span>(<span class="st">".plotInterval"</span>, <span class="st">"numeric"</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Describes the simulation time interval between plot events."</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">inputObjects =</span> <span class="fu">bindrows</span>(</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expectsInput("objectName", "objectClass", "input object description", sourceURL, ...),</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expectsInput</span>(<span class="st">"r"</span>, <span class="at">objectClass =</span> <span class="st">"SpatRaster"</span>, <span class="at">desc =</span> <span class="st">"Template raster"</span>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">outputObjects =</span> <span class="fu">bindrows</span>(</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#createsOutput("objectName", "objectClass", "output object description", ...),</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">createsOutput</span>(<span class="st">"abundRasters"</span>, <span class="st">"list"</span>, <span class="st">"List of layers of species abundance at any given year"</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that the package versions that you define will depend on the ones that are installed on your computer. So take care to change them accordingly. The <code>SpaDES</code> package version suggested by the template reflects the version on your computer.</p>
<p>The rest of the script defines the events and their sequences for this module - remember <code>SpaDES</code> = Spatial Discrete Event Simulator - and the events themselves.</p>
<p><strong>/!\ ATTENTION /!\</strong></p>
<p><em><code>defineModule()</code> is not intended to be run directly by the user – it is run internally during a <code>simInit()</code> call (see <a href="#simulation-setup-in-a-global-script">Simulation setup in a “global” script</a>). In other words, you don’t run any part of a module’s code directly in your session; you run <code>simInit()</code> with that module listed in the modules argument.</em></p>
</section>
<section id="events-and-event-functions" class="level4" data-number="1.2.2.2">
<h4 data-number="1.2.2.2" class="anchored" data-anchor-id="events-and-event-functions"><span class="header-section-number">1.2.2.2</span> <strong>Events and event functions</strong></h4>
<p>Module events are defined and scheduled in the <code>doEvent.&lt;module name&gt;</code> function (in this example, <code>doEvent.speciesAbundance</code> function; see [Scheduling events]. Since we are only interested in simulating and plotting species abundances, we removed unnecessary events from the script and kept: the initialisation (<code>init</code>), an abundance simulation event (<code>SimulAbund</code>) and a plotting event (<code>abundPlot</code>). Each of these events can execute one or more functions.</p>
<p><em>Event functions</em> (actual R functions) mustn’t be confused with <em>event names</em>, which are the names of the events appearing in the <code>doEvent.&lt;module name&gt;</code>.</p>
<p><strong>/!\ ATTENTION /!\</strong></p>
<p><em>Event functions take only one argument, <code>sim</code> (the <code>SpaDES.core::simList</code> object that stores all objects, modules, functions, etc., of a simulation; see <code>?simList</code>) and event functions always (and only) return <code>sim</code> (using <code>return(invisible(sim))</code>).</em></p>
<section id="initialisation-event-function" class="level5" data-number="1.2.2.2.1">
<h5 data-number="1.2.2.2.1" class="anchored" data-anchor-id="initialisation-event-function"><span class="header-section-number">1.2.2.2.1</span> <em>Initialisation event function</em></h5>
<p>The initialisation event function (here, <code>abundanceInit</code>) can be seen as the starting point of the module. Unlike the <code>init</code> event, which must always be present, the function itself does not need to exist (see [Scheduling events]) and can have whatever name we want.</p>
<p>Usually, this function will does pre-simulation steps that are only need to be executed once. In our dummy example, it creates a template raster and a storage list for our species abundance outputs (which will also be rasters). Notice that the only argument to <code>abundanceInit</code> is <code>sim</code>, a <code>simList</code> object that is also its only output.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>abundanceInit <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="do">## create storage list of species abundance</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    sim<span class="sc">$</span>abundRasters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="abundance-simulation-event-function" class="level5" data-number="1.2.2.2.2">
<h5 data-number="1.2.2.2.2" class="anchored" data-anchor-id="abundance-simulation-event-function"><span class="header-section-number">1.2.2.2.2</span> <em>Abundance simulation event function</em></h5>
<p>The function <code>abundanceSim</code> is the core event function of this module, where species abundances are generated via the event. Notice how instead of a <em>for-loop</em>, <code>abundanceSim</code> runs the <code>abundance_model</code> function (which we define separately below) and stores its outputs in the <code>sim$abundRaster</code> object. Notice as well that we use <code>time(sim)</code> as the identifier of the list slots where outputs are stored (see <code>?SpaDES.core::time</code>).</p>
<p>As before, the sole argument and output to this event function is the <code>sim</code> object.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>abundanceSim <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Generate species abundances - our 'simulation'</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    sim<span class="sc">$</span>abundRasters[[<span class="fu">as.character</span>(<span class="fu">time</span>(sim))]] <span class="ot">&lt;-</span> <span class="fu">abundance_model</span>(<span class="at">ras =</span> sim<span class="sc">$</span>r)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>abundanceSim</code> function was called <code>Event1</code> in the template.</p>
</section>
<section id="plotting-event-function" class="level5" data-number="1.2.2.2.3">
<h5 data-number="1.2.2.2.3" class="anchored" data-anchor-id="plotting-event-function"><span class="header-section-number">1.2.2.2.3</span> <em>Plotting event function</em></h5>
<p>Finally, we created the <code>abundancePlot</code> event function to plot the species abundance rasters that are produced by the <code>abundanceSim</code> event function. Again, the sole argument and output of this function is <code>sim</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>abundancePlot <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="do">## plot abundances</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    plotTitle <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Species abundance</span><span class="sc">\n</span><span class="st">at time"</span>, <span class="fu">names</span>(sim<span class="sc">$</span>abundRasters)[<span class="fu">length</span>(sim<span class="sc">$</span>abundRasters)])</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    abundPlot <span class="ot">&lt;-</span> sim<span class="sc">$</span>abundRasters[[<span class="fu">length</span>(sim<span class="sc">$</span>abundRasters)]]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Plot</span>(abundPlot, <span class="at">title =</span> plotTitle, <span class="at">new =</span> <span class="cn">TRUE</span>, <span class="at">addTo =</span> <span class="st">"abundPlot"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>abundancePlot</code> function was called <code>plotFun</code> in the template.</p>
</section>
</section>
<section id="scheduling-events" class="level4" data-number="1.2.2.3">
<h4 data-number="1.2.2.3" class="anchored" data-anchor-id="scheduling-events"><span class="header-section-number">1.2.2.3</span> <strong>Scheduling events</strong></h4>
<p>The order in which module events are executed is determined by the <code>doEvent.&lt;module name&gt;</code> function. This function also defines the events themselves and what happens in them. The <code>switch</code> function executes each event (here <code>init</code>, <code>SimulAbund</code>, and <code>abundPlot</code>) and the events schedule themselves. Two things are of particular importance:</p>
<ol type="1">
<li>The <code>init</code> event is <strong>mandatory</strong>. This is the only event whose <em>name</em> that cannot be changed and that cannot be removed (even if it does not execute any event functions). All other <code>events</code> are optional and can be renamed. <code>SpaDES</code> searches and executes all modules’ <code>init</code> events automatically. Note that the names of event functions executed during <code>init</code> <em>can</em> have any name: here we changed the <code>Init</code> function name (suggested by the template) to <code>abundanceInit</code>.</li>
<li><strong>Events should only schedule themselves</strong>. The only exception is the <code>init</code>, which schedules the first time all other events are executed (even if a particular event only occurs once at the end of the simulation).</li>
</ol>
<p>It is usually easier to fill the <code>doEvent.&lt;module name&gt;</code> function <em>after</em> having defined the event functions (as we did above). For instance, we know that plotting should occur after the generation of species abundances, and so the <code>abundPlot</code> will be scheduled to occur after the <code>SimulAbund</code> event, by changing event priority (see <code>?priority</code>).</p>
<p>This is how we configured our <code>doEvent.speciesAbundance</code> function:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>doEvent.speciesAbundance <span class="ot">=</span> <span class="cf">function</span>(sim, eventTime, eventType,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">debug =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span>(eventType, <span class="at">init =</span> {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        <span class="do">## do stuff for this event</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        sim <span class="ot">&lt;-</span> <span class="fu">abundanceInit</span>(sim)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="do">## schedule future event(s)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="at">eventTime =</span> <span class="fu">start</span>(sim), <span class="at">moduleName =</span> <span class="st">"speciesAbundance"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">eventType =</span> <span class="st">"SimulAbund"</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="at">eventTime =</span> <span class="fu">P</span>(sim)<span class="sc">$</span>.plotInitialTime,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">moduleName =</span> <span class="st">"speciesAbundance"</span>, <span class="at">eventType =</span> <span class="st">"abundPlot"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">eventPriority =</span> <span class="fu">.normal</span>() <span class="sc">+</span> <span class="fl">0.5</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">SimulAbund =</span> {</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="do">## do stuff for this event</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        sim <span class="ot">&lt;-</span> <span class="fu">abundanceSim</span>(sim)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="do">## schedule future event(s)</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="at">eventTime =</span> <span class="fu">time</span>(sim) <span class="sc">+</span> <span class="fu">P</span>(sim)<span class="sc">$</span>simulationTimeStep,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">moduleName =</span> <span class="st">"speciesAbundance"</span>, <span class="at">eventType =</span> <span class="st">"SimulAbund"</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">abundPlot =</span> {</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="do">## do stuff for this event</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        sim <span class="ot">&lt;-</span> <span class="fu">abundancePlot</span>(sim)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="do">## schedule future event(s)</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="at">eventTime =</span> <span class="fu">time</span>(sim) <span class="sc">+</span> <span class="fu">P</span>(sim)<span class="sc">$</span>.plotInterval,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">moduleName =</span> <span class="st">"speciesAbundance"</span>, <span class="at">eventType =</span> <span class="st">"abundPlot"</span>,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">eventPriority =</span> <span class="fu">.normal</span>() <span class="sc">+</span> <span class="fl">0.5</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    }, <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Undefined event type: '"</span>, <span class="fu">current</span>(sim)[<span class="dv">1</span>,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eventType"</span>, <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="st">"' in module '"</span>, <span class="fu">current</span>(sim)[<span class="dv">1</span>,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"moduleName"</span>, <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="st">"'"</span>, <span class="at">sep =</span> <span class="st">""</span>)))</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We suggest having a look at <code>?base::switch</code> too fully understand its behaviour. In short, <code>base::switch</code> tells R to execute (or switch) different code depending on the value of <code>EXPR</code> (here <code>eventType</code>). Here, this means that the behaviour of the function <code>doEvent.speciesAbundance</code> will change depending on the present <code>eventType</code>. So we need to define what behaviour it should have for each event type defined in the module - namely, which functions will be executed and whether to schedule future events with <code>scheduleEvent</code>.</p>
<section id="init" class="level5" data-number="1.2.2.3.1">
<h5 data-number="1.2.2.3.1" class="anchored" data-anchor-id="init"><span class="header-section-number">1.2.2.3.1</span> <strong>init</strong></h5>
<p>The first event is, obviously, <code>init</code> - again <strong>its name cannot be changed</strong>.</p>
<p>In <code>init</code> we run the initialisation event function (<code>abundanceInit</code>) - optional - and schedule the first occurrence of all other events (here, the abundance simulation, <code>SimulAbund</code>, and plotting, <code>abundPlot</code>, events). Because the <code>init</code> is the only event that <code>SpaDES</code> always executes at the start of the simulation, if no events are scheduled during <code>init</code>, no events will be executed after the <code>init</code>. Notice two things:</p>
<ol type="1">
<li>The <code>SimulAbund</code> event is scheduled at <code>start(sim)</code> (i.e.&nbsp;at the first time step of the simulation), which means that it will run after the <code>init</code> event, but still in the same “year”.</li>
<li><code>init</code> schedules the first plotting event to be executed at the time defined by the <code>.plotInitialTime</code> parameter, which is stored in the <code>sim</code> object (and obtained using <code>SpaDES.core::P(sim)</code>), but with a slightly lower event priority <code>eventPriority = .normal()+0.5</code> (see <code>?priority</code>).</li>
</ol>
</section>
<section id="simulabund" class="level5" data-number="1.2.2.3.2">
<h5 data-number="1.2.2.3.2" class="anchored" data-anchor-id="simulabund"><span class="header-section-number">1.2.2.3.2</span> <strong>SimulAbund</strong></h5>
<p>The <code>SimulAbund</code> event is defined next. This event used to be called <code>event1</code> in the template, and we changed its name to be more informative of what it does. It is the core event of this module, where species abundances are generated via the event function <code>abundanceSim</code>.</p>
<p>The even also <strong>schedules itself</strong> to occur at a frequency defined by the <code>simulationTimeStep</code> parameter</p>
</section>
<section id="abundplot" class="level5" data-number="1.2.2.3.3">
<h5 data-number="1.2.2.3.3" class="anchored" data-anchor-id="abundplot"><span class="header-section-number">1.2.2.3.3</span> <strong>abundPlot</strong></h5>
<p>Finally, we schedule the plotting event, <code>abundPlot</code> (which used to be called <code>plot</code> in the template). Similarly to the <code>SimulAbund</code> event, it executes an event function (<code>abundancePlot</code>) and reschedules itself. An important difference is that it uses the <code>.plotInterval</code> parameter, instead of <code>simulationTimeStep</code>, when rescheduling itself. This way, future events will occur depending on the time step and plot interval parameters defined in the global script (or their default values defined in the metadata section).</p>
</section>
</section>
<section id="inputobjects-function" class="level4" data-number="1.2.2.4">
<h4 data-number="1.2.2.4" class="anchored" data-anchor-id="inputobjects-function"><span class="header-section-number">1.2.2.4</span> <strong><code>.inputObjects</code> function</strong></h4>
<p>The end of the template <code>.R</code> script defines a function called <code>.inputObjects</code>. This is where the developer should include code to provide the defaults for any input objects required by the module. This is the ideal place to produce the template raster, <code>r</code> , instead of doing so in <code>abundanceInit</code>. This will allow a future user (or module) to provide their own <code>r</code> object (e.g.&nbsp;for another study area). If on the other hand we don’t do this and create <code>r</code> during the <code>init</code> event, any <code>r</code> supplied by the user will be overridden by the execution of <code>init</code>.</p>
<p>As a rule of thumb, default inputs should be created in a way that allows their values to be overridden by the user (by supplying a named list of objects via <code>simInit(objects = ...)</code>) or by any other modules that produce these objects. For this, we rely on the <code>SpaDES.core::suppliedElsewhere</code> function, which detects if a given object has already been supplied by the user or if it will be supplied by another module.</p>
<p>Note that <code>suppliedElsewhere</code> does not know whether the module that supplies the object will be executed <em>before</em> the present module, as it is blind to module scheduling order. When modules are relatively simple and have an approximately linear flow of interdependencies, <code>SpaDES</code> is usually able to tell the order in which modules need to be executed. In more complex cases it is a good idea to pass a vector of module names to <code>simInit(loadOrder = ...)</code> definining the order of module execution.</p>
<p>Here’s an example of how to do this (the commented instructions have been deleted):</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>.inputObjects <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">suppliedElsewhere</span>(<span class="st">"r"</span>)) {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="do">## make template raster if not supplied elsewhere.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        sim<span class="sc">$</span>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="at">nrows =</span> <span class="dv">100</span>, <span class="at">ncols =</span> <span class="dv">100</span>, <span class="at">xmin =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">xmax =</span> <span class="dv">50</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">ymin =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">ymax =</span> <span class="dv">50</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If we choose to supply the default <code>r</code> in <code>.inputObjects</code>, then we need to remove its creation from the <code>abundanceInit</code> function and add <code>r</code> to the metadata as an input. We have done this, so that <code>abundanceInit</code> only creates a storage list for the outputs:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>abundanceInit <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="do">## create storage list of species abundance</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    sim<span class="sc">$</span>abundRasters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It is good practice to provide default input objects to all remaining modules, so that they can work stand-alone. We have done this below.</p>
<p><strong>/!\ ATTENTION /!\</strong></p>
<p><em>If <code>r</code> becomes an input with defaults it must be <strong>added to the module metadata</strong> inside an <code>expectsInput</code> call.</em></p>
</section>
<section id="additional-module-functions" class="level4" data-number="1.2.2.5">
<h4 data-number="1.2.2.5" class="anchored" data-anchor-id="additional-module-functions"><span class="header-section-number">1.2.2.5</span> <strong>Additional module functions</strong></h4>
<p>Events can also rely on other functions that can either be sourced from other scripts, or defined at the end of the module script (e.g.&nbsp;usually before <code>.inputObjects</code>, although the order is irrelevant). This is the case for the species abundances generator function, which we coded in a separate script called <code>abundance_model.R</code>. Scripts with accessory functions like these go into module’s <code>R/</code> folder.</p>
<p>Functions should also be accompanied by metadata. Here we provide a description of the function, its parameters, returning value and what other package functions it relies on using the <code>roxygen2</code> documentation style (indicated by <code>#'</code>).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Accessory function to speciesAbundance module</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ras a raster layer used as template.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a fake abundance SpatRaster generated as a Gaussian map with scale = 100 and variance = 0.01</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom NLMR nlm_mpd</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom terra rast</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>abundance_model <span class="ot">&lt;-</span> <span class="cf">function</span>(ras) {</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    abund_ras <span class="ot">&lt;-</span> NLMR<span class="sc">::</span><span class="fu">nlm_mpd</span>(<span class="at">ncol =</span> <span class="fu">ncol</span>(ras), <span class="at">nrow =</span> <span class="fu">nrow</span>(ras),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">resolution =</span> <span class="fu">unique</span>(<span class="fu">res</span>(ras)), <span class="at">roughness =</span> <span class="fl">0.5</span>, <span class="at">rand_dev =</span> <span class="dv">100</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">rescale =</span> <span class="cn">TRUE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rast</span>()</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(abund_ras)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
</section>
<section id="creating-and-adding-additional-modules-the-temperature-module" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="creating-and-adding-additional-modules-the-temperature-module"><span class="header-section-number">1.2.3</span> Creating and adding additional modules: the <em>temperature</em> module</h3>
<p>The order in which modules are first executed (i.e.&nbsp;their <code>init</code> events) can be automatically determined by inter-module dependencies (i.e.&nbsp;module inputs that are the outputs of other modules). If there are no inter-module dependencies this order is determined by the order in which the modules are listed in the <code>Part1_DummyModel.R</code> script, or via the <code>simInit(loadOrder = ...)</code> argument.</p>
<p>After the <code>init</code> event, the module execution order follows the order of events. This means that a module’s events can be scheduled before and after another module’s events within the same simulation time step. However, keep in mind that this can make the simulation flow hard to follow, debug and change when additional modules are added.</p>
<p>The second module we created generates yearly temperatures. Apart from different objects and functions names, this module also has the template raster <code>r</code> as required input object. Recall that <code>r</code> is created during the <code>.inputObjects</code> of the <em>speciesAbundance</em> module. When the two modules are linked, this object will not be created twice because <code>suppliedElsewhere("r")</code> will tell the <em>temperature</em> module that `r` will be supplied by another module. This may appear trivial in this example, but it can be extremely useful when inuts are heavy objects that require lengthy computations to be produces.</p>
<p>This is how we set up the <code>temperature.R</code> script looks like:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Everything in this file gets sourced during simInit, and all functions and objects</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># are put into the simList.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">defineModule</span>(sim, <span class="fu">list</span>(</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"temperature"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">description =</span> <span class="st">"Temperature simulator"</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">keywords =</span> <span class="fu">c</span>(<span class="st">"temperature"</span>, <span class="st">"gaussian"</span>, <span class="st">"spatial"</span>),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">authors =</span> <span class="fu">structure</span>(<span class="fu">list</span>(<span class="fu">list</span>(<span class="at">given =</span> <span class="fu">c</span>(<span class="st">"Ceres"</span>), <span class="at">family =</span> <span class="st">"Barros"</span>, </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                                <span class="at">role =</span> <span class="fu">c</span>(<span class="st">"aut"</span>, <span class="st">"cre"</span>), <span class="at">email =</span> <span class="st">"ceres.barros@ubc.ca"</span>, <span class="at">comment =</span> <span class="cn">NULL</span>)), <span class="at">class =</span> <span class="st">"person"</span>),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">childModules =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">version =</span> <span class="fu">list</span>(<span class="at">temperature =</span> <span class="st">"1.0.0"</span>),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeframe =</span> <span class="fu">as.POSIXlt</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>)),</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeunit =</span> <span class="st">"year"</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">citation =</span> <span class="fu">list</span>(<span class="st">"citation.bib"</span>),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">documentation =</span> <span class="fu">list</span>(<span class="st">"README.txt"</span>, <span class="st">"temperature.Rmd"</span>),</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">reqdPkgs =</span> <span class="fu">list</span>(<span class="st">"SpaDES.core (&gt;=2.0.2)"</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"terra"</span>, <span class="st">"ropensci/NLMR"</span>),</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>   <span class="at">parameters =</span> <span class="fu">bindrows</span>(</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#defineParameter("paramName", "paramClass", value, min, max, "parameter description"),</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">defineParameter</span>(<span class="st">"simulationTimeStep"</span>, <span class="st">"numeric"</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"This describes the simulation time step interval"</span>),</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">defineParameter</span>(<span class="st">".plotInitialTime"</span>, <span class="st">"numeric"</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"This describes the simulation time at which the first plot event should occur"</span>),</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">defineParameter</span>(<span class="st">".plotInterval"</span>, <span class="st">"numeric"</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"This describes the simulation time interval between plot events"</span>)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">inputObjects =</span> <span class="fu">bindrows</span>(</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#expectsInput("objectName", "objectClass", "input object description", sourceURL, ...),</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expectsInput</span>(<span class="st">"r"</span>, <span class="st">"SpatRaster"</span>, <span class="st">"Template raster"</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">outputObjects =</span> <span class="fu">bindrows</span>(</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#createsOutput("objectName", "objectClass", "output object description", ...),</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">createsOutput</span>(<span class="st">"tempRasters"</span>,  <span class="st">"list"</span>, <span class="st">"List of raster layers of temperature at any given year"</span>)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="do">## event types</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="co">#   - type `init` is required for initialiazation</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>doEvent.temperature <span class="ot">=</span> <span class="cf">function</span>(sim, eventTime, eventType, <span class="at">debug =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span>(</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">init =</span> {</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>      <span class="do">## do stuff for this event</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">Init</span>(sim)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>      <span class="do">## schedule future event(s)</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="at">eventTime =</span> <span class="fu">start</span>(sim), <span class="at">moduleName =</span> <span class="st">"temperature"</span>, <span class="at">eventType =</span> <span class="st">"SimulTemp"</span>)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="at">eventTime =</span> <span class="fu">P</span>(sim)<span class="sc">$</span>.plotInitialTime, <span class="at">moduleName =</span> <span class="st">"temperature"</span>, </span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>                           <span class="at">eventType =</span> <span class="st">"tempPlot"</span>, <span class="at">eventPriority =</span> <span class="fu">.normal</span>() <span class="sc">+</span> <span class="fl">0.5</span>)</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">SimulTemp =</span> {</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>      <span class="do">## do stuff for this event</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">update</span>(sim)</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>      <span class="do">## schedule future event(s)</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="at">eventTime =</span> <span class="fu">time</span>(sim) <span class="sc">+</span> <span class="fu">P</span>(sim)<span class="sc">$</span>simulationTimeStep, <span class="at">moduleName =</span> <span class="st">"temperature"</span>, </span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>                           <span class="at">eventType =</span> <span class="st">"SimulTemp"</span>)</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">tempPlot =</span> {</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>      <span class="do">## do stuff for this event</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">plotting</span>(sim)</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>      <span class="do">## schedule future event(s)</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="at">eventTime =</span> <span class="fu">time</span>(sim) <span class="sc">+</span> <span class="fu">P</span>(sim)<span class="sc">$</span>.plotInterval, <span class="at">moduleName =</span> <span class="st">"temperature"</span>, </span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>                           <span class="at">eventType =</span> <span class="st">"tempPlot"</span>, <span class="at">eventPriority =</span> <span class="fu">.normal</span>() <span class="sc">+</span> <span class="fl">0.5</span>)</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Undefined event type: '"</span>, <span class="fu">current</span>(sim)[<span class="dv">1</span>, <span class="st">"eventType"</span>, <span class="at">with =</span> <span class="cn">FALSE</span>],</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"' in module '"</span>, <span class="fu">current</span>(sim)[<span class="dv">1</span>, <span class="st">"moduleName"</span>, <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="st">"'"</span>, <span class="at">sep =</span> <span class="st">""</span>))</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a><span class="do">## This is the 'init' event:</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>Init <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create storage list of species temperature</span></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>  sim<span class="sc">$</span>tempRasters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a><span class="do">## This is the temperature simulation event function</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>update <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate temperature - our "updated data"</span></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>  sim<span class="sc">$</span>tempRasters[[<span class="fu">as.character</span>(<span class="fu">time</span>(sim))]] <span class="ot">&lt;-</span> <span class="fu">temperature_model</span>(<span class="at">ras =</span> sim<span class="sc">$</span>r)</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a><span class="do">## This is the plotting event funciton</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>plotting <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>  <span class="do">## plot temperature</span></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>  plotTitle <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Temperature</span><span class="sc">\n</span><span class="st">at time"</span>,</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">names</span>(sim<span class="sc">$</span>tempRasters)[<span class="fu">length</span>(sim<span class="sc">$</span>tempRasters)])</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>  tempPlot <span class="ot">&lt;-</span> sim<span class="sc">$</span>tempRasters[[<span class="fu">length</span>(sim<span class="sc">$</span>tempRasters)]] </span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Plot</span>(tempPlot, </span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> plotTitle, </span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>       <span class="at">new =</span> <span class="cn">TRUE</span>, <span class="at">addTo =</span> <span class="st">"tempPlot"</span>)</span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>.inputObjects <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">suppliedElsewhere</span>(<span class="st">"r"</span>)) {</span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>    <span class="do">## make template raster if not supplied elsewhere.</span></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>    sim<span class="sc">$</span>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="at">nrows =</span> <span class="dv">100</span>, <span class="at">ncols =</span> <span class="dv">100</span>, <span class="at">xmin =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">xmax =</span> <span class="dv">50</span>, <span class="at">ymin =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">ymax =</span> <span class="dv">50</span>)</span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Again, we added an accessory <code>temperature_model</code> function in a separate script <code>R/temperature_model.R</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Accessory function to temperature module</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ras a raster layer used as template.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a fake temperature SpatRaster generated as a Gaussian map with scale = 100 and variance = 0.01</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom NLMR nlm_mpd</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom terra rast</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>temperature_model <span class="ot">&lt;-</span> <span class="cf">function</span>(ras) {</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    temp_ras <span class="ot">&lt;-</span> NLMR<span class="sc">::</span><span class="fu">nlm_mpd</span>(<span class="at">ncol =</span> <span class="fu">ncol</span>(ras), <span class="at">nrow =</span> <span class="fu">nrow</span>(ras),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">resolution =</span> <span class="fu">unique</span>(<span class="fu">res</span>(ras)), <span class="at">roughness =</span> <span class="fl">0.5</span>, <span class="at">rand_dev =</span> <span class="dv">10</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">rescale =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rast</span>()</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(temp_ras)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
<section id="modules-that-depend-on-other-modules-the-speciestemplm-module" class="level3" data-number="1.2.4">
<h3 data-number="1.2.4" class="anchored" data-anchor-id="modules-that-depend-on-other-modules-the-speciestemplm-module"><span class="header-section-number">1.2.4</span> Modules that depend on other modules: the <em>speciesTempLM</em> module</h3>
<p>Our third and last module, <em>speciesTempLM</em>, will be used to run the statistical analysis at each year, after the abundances and temperatures are generated (<strong>species</strong> and <strong>Temp</strong>erature <strong>L</strong>inear <strong>M</strong>odel). Hence, it will depend on the outputs of the <em>speciesAbundance</em> and the <em>temperature</em> modules.</p>
<p>The interest of keeping the statistical analysis in a separate module lies on the fact that it allows us to easily swap and compare different statistical models to analyse our data if we want to.</p>
<p>It also allows for greater flexibility when it comes to <strong>when</strong> the statistical model is supposed to run. For example, we may want to fit it at every 5 years, instead of every year, using the previous 5 years of data. By having the statistical analysis contained in its own module, we don’t need to change other module scripts in order to make these changes.</p>
<p>Finally, we draw your attention to a few differences in this module’s script before we see it:</p>
<ul>
<li><p>The <strong>frequency</strong> of the statistical analysis (and correspondent plots) will be determined by the parameter <code>statsTimestep</code>. This parameter also determines the number of data years to be used to fit the linear model. If <code>statsTimestep = 5</code>, the statistical analysis will use the precedent 5 years of data including the year in which the event is running (a total of 6 years of data);</p></li>
<li><p>This module <strong>requires inputs</strong> that have no defaults in <code>.inputObjects</code>. They are specified in <code>inputObjects</code> part of <code>defineModule</code> - notice how we’ve respected the names, classes and description of the objects that come from the <em>speciesAbundance</em> and the <em>temperature</em> modules;</p></li>
<li><p>We have <strong>two additional functions</strong> in a separate script (<code>R/linear_model_functions.R</code>): the function fitting the linear model and a plotting function.</p></li>
</ul>
<p>Below is the full module script. Notice how the future events where scheduled to <code>P(sim)$statsTimestep + 0.1</code>, to force the statistical analyses to occur <strong>after</strong> the abundance and temperature rasters are ready.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Everything in this file gets sourced during simInit, and all functions and objects</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># are put into the simList.</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">defineModule</span>(sim, <span class="fu">list</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"speciesTempLM"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">description =</span> <span class="st">"Statistical analysis of species ~ temperature relationships using LM"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">keywords =</span> <span class="fu">c</span>(<span class="st">"linear model"</span>),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">authors =</span> <span class="fu">structure</span>(<span class="fu">list</span>(<span class="fu">list</span>(<span class="at">given =</span> <span class="fu">c</span>(<span class="st">"Ceres"</span>), <span class="at">family =</span> <span class="st">"Barros"</span>, </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                                <span class="at">role =</span> <span class="fu">c</span>(<span class="st">"aut"</span>, <span class="st">"cre"</span>), <span class="at">email =</span> <span class="st">"ceres.barros@ubc.ca"</span>, <span class="at">comment =</span> <span class="cn">NULL</span>)), <span class="at">class =</span> <span class="st">"person"</span>),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">childModules =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">version =</span> <span class="fu">list</span>(<span class="at">speciesTempLM =</span> <span class="st">"1.0.0"</span>),</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeframe =</span> <span class="fu">as.POSIXlt</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>)),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeunit =</span> <span class="st">"year"</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">citation =</span> <span class="fu">list</span>(<span class="st">"citation.bib"</span>),</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">documentation =</span> <span class="fu">list</span>(<span class="st">"README.txt"</span>, <span class="st">"speciesTempLM.Rmd"</span>),</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">reqdPkgs =</span> <span class="fu">list</span>(<span class="st">"SpaDES.core (&gt;=2.0.2)"</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"terra"</span>, <span class="st">"ggplot2"</span>, <span class="st">"data.table"</span>, <span class="st">"reshape2"</span>),</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>   <span class="at">parameters =</span> <span class="fu">bindrows</span>(</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#defineParameter("paramName", "paramClass", value, min, max, "parameter description"),</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">defineParameter</span>(<span class="st">"statsTimestep"</span>, <span class="st">"numeric"</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="st">"This describes the how often the statitiscal analysis will be done"</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">inputObjects =</span> <span class="fu">bindrows</span>(</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#expectsInput("objectName", "objectClass", "input object description", sourceURL, ...),</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expectsInput</span>(<span class="st">"abundRasters"</span>, <span class="st">"list"</span>, <span class="st">"List of raster layers of species abundance at any given year"</span>),</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expectsInput</span>(<span class="st">"tempRasters"</span>, <span class="st">"list"</span>, <span class="st">"List of raster layers of temperature at any given year"</span>)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">outputObjects =</span> <span class="fu">bindrows</span>(</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#createsOutput("objectName", "objectClass", "output object description", ...),</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">createsOutput</span>(<span class="st">"outputdata"</span>, <span class="st">"list"</span>, <span class="st">"List of dataframes containing species abundances and temperature values per pixel"</span>),</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">createsOutput</span>(<span class="st">"outputLM"</span>, <span class="st">"list"</span>, <span class="st">"List of output yearly LMs (abundance ~ temperature)"</span>),</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">createsOutput</span>(<span class="st">"yrs"</span>, <span class="st">"numeric"</span>, <span class="st">"Vector of years used for statistical analysis"</span>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="do">## event types</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   - type `init` is required for initialiazation</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>doEvent.speciesTempLM <span class="ot">=</span> <span class="cf">function</span>(sim, eventTime, eventType, <span class="at">debug =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span>(</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">init =</span> {</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>      <span class="do">## do stuff for this event</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">statsInit</span>(sim)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>      <span class="do">## schedule future event(s)</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="fu">P</span>(sim)<span class="sc">$</span>statsTimestep, <span class="st">"speciesTempLM"</span>, </span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"stats"</span>, <span class="at">eventPriority =</span> <span class="fu">.normal</span>() <span class="sc">+</span> <span class="dv">2</span>)</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="fu">P</span>(sim)<span class="sc">$</span>statsTimestep, <span class="st">"speciesTempLM"</span>, </span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"statsPlot"</span>, <span class="at">eventPriority =</span> <span class="fu">.normal</span>() <span class="sc">+</span> <span class="fl">2.5</span>)</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">stats =</span> {</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>      <span class="do">## do stuff for this event</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">statsAnalysis</span>(sim)</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>      <span class="do">## schedule future event(s)</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="fu">time</span>(sim) <span class="sc">+</span> <span class="fu">P</span>(sim)<span class="sc">$</span>statsTimestep, <span class="st">"speciesTempLM"</span>, </span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"stats"</span>, <span class="at">eventPriority =</span> <span class="fu">.normal</span>() <span class="sc">+</span> <span class="dv">2</span>)</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">statsPlot =</span> {</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>      <span class="do">## do stuff for this event</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">statsPlot</span>(sim)</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>      <span class="do">## schedule future event(s)</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>      sim <span class="ot">&lt;-</span> <span class="fu">scheduleEvent</span>(sim, <span class="fu">time</span>(sim) <span class="sc">+</span> <span class="fu">P</span>(sim)<span class="sc">$</span>statsTimestep, <span class="st">"speciesTempLM"</span>,</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"statsPlot"</span>, <span class="at">eventPriority =</span> <span class="fu">.normal</span>() <span class="sc">+</span> <span class="fl">2.5</span>)</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Undefined event type: '"</span>, <span class="fu">current</span>(sim)[<span class="dv">1</span>, <span class="st">"eventType"</span>, <span class="at">with =</span> <span class="cn">FALSE</span>],</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"' in module '"</span>, <span class="fu">current</span>(sim)[<span class="dv">1</span>, <span class="st">"moduleName"</span>, <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="st">"'"</span>, <span class="at">sep =</span> <span class="st">""</span>))</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a><span class="do">## template initialization</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>statsInit <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create outputs storage lists</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>  sim<span class="sc">$</span>outputLM <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a><span class="do">## Statistical analysis event</span></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>statsAnalysis <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get all species abundances data available</span></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>  abundData <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">rast</span>(sim<span class="sc">$</span>abundRasters))</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>  abundData[, pixID <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(abundData)]</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>  abundData <span class="ot">&lt;-</span> <span class="fu">melt.data.table</span>(abundData, <span class="at">id.var =</span> <span class="st">"pixID"</span>,</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>                               <span class="at">variable.name =</span> <span class="st">"year"</span>, <span class="at">value.name =</span> <span class="st">"abund"</span>)</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>  abundData[, year <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(<span class="fu">sub</span>(<span class="st">"X"</span>, <span class="st">""</span>, year))]</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get all temperature data available</span></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>  tempData <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">rast</span>(sim<span class="sc">$</span>tempRasters))</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>  tempData[, pixID <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(tempData)]</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>  tempData <span class="ot">&lt;-</span> <span class="fu">melt.data.table</span>(tempData, <span class="at">id.var =</span> <span class="st">"pixID"</span>,</span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>                              <span class="at">variable.name =</span> <span class="st">"year"</span>, <span class="at">value.name =</span> <span class="st">"temp"</span>)</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>  tempData[, year <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(<span class="fu">sub</span>(<span class="st">"X"</span>, <span class="st">""</span>, year))] </span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>  <span class="do">## merge per year  </span></span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkey</span>(abundData, pixID, year)</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkey</span>(tempData, pixID, year)</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>  sim<span class="sc">$</span>outputdata <span class="ot">&lt;-</span> abundData[tempData]</span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>  sim<span class="sc">$</span>outputLM[[<span class="fu">as.character</span>(<span class="fu">time</span>(sim))]] <span class="ot">&lt;-</span> <span class="fu">linearModel</span>(<span class="at">Data =</span> sim<span class="sc">$</span>outputdata)</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a><span class="do">## Plotting event</span></span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>statsPlot <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> sim<span class="sc">$</span>outputLM[[<span class="fu">as.character</span>(<span class="fu">time</span>(sim))]]</span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>  modelPlot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(sim<span class="sc">$</span>outputdata) <span class="sc">+</span> </span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> temp, <span class="at">y =</span> abund)) <span class="sc">+</span></span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> model<span class="sc">$</span>coefficients[<span class="st">"(Intercept)"</span>], </span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a>                <span class="at">slope =</span> model<span class="sc">$</span>coefficients[<span class="st">"temp"</span>], <span class="at">size =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Temp."</span>, <span class="at">y =</span> <span class="st">"Species abundance"</span>)</span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>  plotTitle <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"abundance ~ temperature</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"years"</span>, <span class="fu">range</span>(sim<span class="sc">$</span>outputdata<span class="sc">$</span>year)[<span class="dv">1</span>],</span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"to"</span>, <span class="fu">range</span>(sim<span class="sc">$</span>outputdata<span class="sc">$</span>year)[<span class="dv">2</span>])</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Plot</span>(modelPlot, </span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> plotTitle, </span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>       <span class="at">new =</span> <span class="cn">TRUE</span>, <span class="at">addTo =</span> <span class="st">"modelPlot"</span>)</span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a>.inputObjects <span class="ot">&lt;-</span> <span class="cf">function</span>(sim) {</span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Any code written here will be run during the simInit for the purpose of creating</span></span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># any objects required by this module and identified in the inputObjects element of defineModule.</span></span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is useful if there is something required before simulation to produce the module</span></span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># object dependencies, including such things as downloading default datasets, e.g.,</span></span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># downloadData("LCC2005", modulePath(sim)).</span></span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Nothing should be created here that does not create a named object in inputObjects.</span></span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Any other initiation procedures should be put in "init" eventType of the doEvent function.</span></span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note: the module developer can check if an object is 'suppliedElsewhere' to</span></span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selectively skip unnecessary steps because the user has provided those inputObjects in the</span></span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simInit call, or another module will supply or has supplied it. e.g.,</span></span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if (!suppliedElsewhere('defaultColor', sim)) {</span></span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   sim$map &lt;- Cache(prepInputs, extractURL('map')) # download, extract, load file from url in sourceURL</span></span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a>  <span class="co">#cacheTags &lt;- c(currentModule(sim), "function:.inputObjects") ## uncomment this if Cache is being used</span></span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a>  dPath <span class="ot">&lt;-</span> <span class="fu">asPath</span>(<span class="fu">getOption</span>(<span class="st">"reproducible.destinationPath"</span>, <span class="fu">dataPath</span>(sim)), <span class="dv">1</span>)</span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">currentModule</span>(sim), <span class="st">": using dataPath '"</span>, dPath, <span class="st">"'."</span>)</span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span id="cb20-149"><a href="#cb20-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(sim))</span>
<span id="cb20-150"><a href="#cb20-150" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And the script with the accessory functions:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Accessory functions to speciesTempLM module</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Accessory function to speciesTempLM module that calculates a</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'  linear regression between species abundances and temperature</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param Data a data.frame or data.table that contains an \code{abund}</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'   column and a \code{temp} column with abundance and temperature values </span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'   in each location, respectively.</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a linear model (\code{lm}) object fitted with the formula:</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'  \code{abund ~ temp}</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>linearModel <span class="ot">&lt;-</span> <span class="cf">function</span>(Data) {</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(abund <span class="sc">~</span> temp, <span class="at">data =</span> Data)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(lm1)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
<section id="simulation" class="level3" data-number="1.2.5">
<h3 data-number="1.2.5" class="anchored" data-anchor-id="simulation"><span class="header-section-number">1.2.5</span> Simulation</h3>
<section id="simulation-setup-in-a-global-script" class="level4" data-number="1.2.5.1">
<h4 data-number="1.2.5.1" class="anchored" data-anchor-id="simulation-setup-in-a-global-script"><span class="header-section-number">1.2.5.1</span> Simulation setup in a “global” script</h4>
<p>We can now go back to our <code>Part1_DummyModel.R</code> script and set the simulation up.</p>
<p>The function <code>simInit</code> needs a few arguments listing simulation folder directories, parameters, simulation times, modules and, optionally, input objects supplied by the user. <code>simInit</code> will prepare a simulation object that can later be run by the <code>spades</code> function:</p>
<ul>
<li><p>The first list, <code>modules</code>, contains modules we want to activate.</p></li>
<li><p><code>times</code> is a named list containing the start and end times of the simulation and what time units we’re working with (with “start” and “end” being the list <code>names</code>. It thus defines the length of the simulation. It is important that the start and ending times are defined in decimals, because <code>SpaDES</code> allows decomposing time units into smaller fractions.</p></li>
<li><p><code>parameters</code> is a named list of named lists, containing parameters values passed to each module. Note that because the module metadata will (or should) contain default parameter values, here we pass only parameters which we want to change with respect to their defaults. For instance, <code>.plotInterval</code> is used and defined in the <em>speciesAbundance</em> and <em>temperature</em> modules, but not passed to the <code>simInit</code> function because we want to use the default value. As a developer providing a reproducible example, we may also chose to list important and useful parameters, even if the value is the same as the default. Here we chose to list <code>.plotInitialTime</code> (a parameter used and defined in the <em>speciesAbundance</em> and <em>temperature</em> modules), but provide the default value (we experimenting with it by changing its value in the <code>Part1_DummyModel.R</code>).</p></li>
<li><p><code>paths</code> contains the folder directory paths that we set earlier.</p></li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## list the modules to use</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>simModules <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"speciesAbundance"</span>, <span class="st">"temperature"</span>, <span class="st">"speciesTempLM"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Set simulation and module parameters</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>simTimes <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">10</span>, <span class="at">timeunit =</span> <span class="st">"year"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>simParams <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">speciesAbundance =</span> <span class="fu">list</span>(<span class="at">simulationTimeStep =</span> <span class="dv">1</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.plotInitialTime =</span> <span class="dv">1</span>), <span class="at">temperature =</span> <span class="fu">list</span>(<span class="at">simulationTimeStep =</span> <span class="dv">1</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.plotInitialTime =</span> <span class="dv">1</span>), <span class="at">speciesTempLM =</span> <span class="fu">list</span>(<span class="at">statsTimestep =</span> <span class="dv">5</span>))</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="do">## make a list of directory paths</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>simPaths <span class="ot">&lt;-</span> <span class="fu">getPaths</span>()</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Simulation setup</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>mySim <span class="ot">&lt;-</span> <span class="fu">simInit</span>(<span class="at">times =</span> simTimes, <span class="at">params =</span> simParams, <span class="at">modules =</span> simModules,</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">paths =</span> simPaths)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, we highlight that <code>simInit</code> also executes all <code>.inputObjects</code> functions, and schedules the <code>init</code> events, but does not execute them:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">events</span>(mySim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="checking-the-simulation-setup" class="level4" data-number="1.2.5.2">
<h4 data-number="1.2.5.2" class="anchored" data-anchor-id="checking-the-simulation-setup"><span class="header-section-number">1.2.5.2</span> Checking the simulation setup</h4>
<p>Before starting the simulations we should check if the modules were linked correctly.</p>
<p><strong>Module diagram</strong></p>
<p><code>moduleDiagram</code> (<a href="#fig-moduleDiagram" class="quarto-xref">Figure&nbsp;<span>1.2</span></a> ) is a useful function that shows module inter-dependencies as a network diagram. The direction of the arrows indicates an output to input flow. You can see that <em>speciesAbundance</em> and <em>temperature</em> inputs (specifically our `r` raster) are supplied by an external source (<em>INPUT</em>) - the user or <code>.inputObjects</code>. Whereas the inputs to the <em>speciesTempLM</em> module are outputs of the <em>speciesAbundance</em> and <em>temperature</em> modules.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">moduleDiagram</span>(mySim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-moduleDiagram" class="quarto-figure quarto-figure-center anchored" width="576">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-moduleDiagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Part1_DummyModel_files/figure-html/fig-moduleDiagram-1.png" class="img-fluid figure-img" width="576">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-moduleDiagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.2: Diagram of module connections.
</figcaption>
</figure>
</div>
</div>
</div>
<p><strong>Object diagram</strong></p>
<p><code>objectDiagram</code> (<a href="#fig-objectDiagram" class="quarto-xref">Figure&nbsp;<span>1.3</span></a>) provides another way of checking module linkages. It explicitly shows module inter-dependencies by depicting the objects that establish links between modules.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">objectDiagram</span>(mySim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-objectDiagram" class="quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-objectDiagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./home/runner/work/SpaDES4Dummies/SpaDES4Dummies/figures/Part1_objectDiagram.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-objectDiagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.3: Module diagram showing module inter-dependencies with object names.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="running-spades" class="level4" data-number="1.2.5.3">
<h4 data-number="1.2.5.3" class="anchored" data-anchor-id="running-spades"><span class="header-section-number">1.2.5.3</span> Running <code>SpaDES</code></h4>
<p>We run the simulation using the <code>spades</code> function, which takes the output of the <code>simInit</code>, executes the already scheduled <code>init</code> events, which schedule the remainder of the events. We passed <code>debug = TRUE</code> so that <code>spades</code> prints the events as they are being executed. In case something fails, this helps diagnosing where the issue occurred.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## run simulation</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dev</span>()  <span class="co"># on Windows and Mac, this opens external device if using Rstudio, it is faster</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">clearPlot</span>()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>mySim2 <span class="ot">&lt;-</span> <span class="fu">spades</span>(mySim, <span class="at">debug =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./home/runner/work/SpaDES4Dummies/SpaDES4Dummies/figures/simul_plot.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Simulation plots: Final plot of the simulation</figcaption>
</figure>
</div>
</div>
</div>
<p>We suggest experimenting with changing parameter values and trying to create and add other modules to further explore all the <code>SpaDES</code> flexibility. The more complex the project gets, the more advantageous it is to use <code>SpaDES</code> to turn modules <em>on</em> or <em>off</em>, swapping modules to run, e.g., different statistical analyses, or to include different data.</p>
<hr>
</section>
</section>
<section id="additional-notes" class="level3" data-number="1.2.6">
<h3 data-number="1.2.6" class="anchored" data-anchor-id="additional-notes"><span class="header-section-number">1.2.6</span> Additional notes</h3>
<p><code>SpaDES</code> is an extremely powerful package, whose potential goes well beyond what has been discussed in this dummy example. If you want to explore it further, we recommend following <a href="./Part2_SDMs.html">Chapter 2</a> for a more realistic (but still simple) <code>SpaDES</code> application.</p>
<p>Also, do go to the <a href="https://spades.predictiveecology.org/"><code>SpaDES</code> webpage</a> to find further information about the platform, as well as upcoming workshops and publications and to the <a href="https://github.com/PredictiveEcology/">Predictive Ecology Github repository</a> to see all the <code>SpaDES</code> modules and SpaDES-related packages that we maintain at the <a href="https://predictiveecology.org">Predictive Ecology Lab</a>.</p>
<hr>
<center>
<strong>Happy SpaDESing!</strong>
</center>


</section>
</section>
<aside id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>The full R script to run this example <a href="appendices/Part1_Rscript.html" class="quarto-xref"><span>Appendix&nbsp;A</span></a> .<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</aside>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link  aria-label=" preface"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Preface</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Part2_SDMs.html" class="pagination-link" aria-label="<span class='chapter-number'>2</span>&nbsp; <span class='chapter-title'>A more realistic example of `SpaDES`</span>">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A more realistic example of <code>SpaDES</code></span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>SpaDES For Dummies was written by Ceres Barros, Eliot McIntire, Tati Michelleti and Alex Chubaty.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>
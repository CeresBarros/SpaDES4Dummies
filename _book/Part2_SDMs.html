<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.489">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>SpaDES For Dummies - 2&nbsp; A more realistic example of SpaDES</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./References.html" rel="next">
<link href="./Part1_DummyModel.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="css/style.css">
<meta name="twitter:title" content="SpaDES For Dummies - 2&nbsp; A more realistic example of SpaDES">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">SpaDES For Dummies</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/CeresBarros/SpaDES4Dummies"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools tools-wide">
    <a href="./SpaDES-For-Dummies.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Part2_SDMs.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A more realistic example of `SpaDES`</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Part1_DummyModel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducing <code>SpaDES</code> with a dummy ecological model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Part2_SDMs.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A more realistic example of <code>SpaDES</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./References.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendices/Part1_Rscript.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Complete R script to Chapter 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendices/Part2_Rscript.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Complete R script to Chapter 2</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#the-example-projecting-species-distribution-shifts-under-climate-change" id="toc-the-example-projecting-species-distribution-shifts-under-climate-change" class="nav-link active" data-scroll-target="#the-example-projecting-species-distribution-shifts-under-climate-change"><span class="header-section-number">2.1</span> The example: projecting species distribution shifts under climate change</a></li>
  <li>
<a href="#module-creation-and-coding" id="toc-module-creation-and-coding" class="nav-link" data-scroll-target="#module-creation-and-coding"><span class="header-section-number">2.2</span> Module creation and coding</a>
  <ul>
<li>
<a href="#data-modules" id="toc-data-modules" class="nav-link" data-scroll-target="#data-modules"><span class="header-section-number">2.2.1</span> Data modules</a>
  <ul class="collapse">
<li><a href="#speciesabundancedata-module" id="toc-speciesabundancedata-module" class="nav-link" data-scroll-target="#speciesabundancedata-module"><span class="header-section-number">2.2.1.1</span> <em>speciesAbundanceData</em> module:</a></li>
  <li><a href="#climatedata-module" id="toc-climatedata-module" class="nav-link" data-scroll-target="#climatedata-module"><span class="header-section-number">2.2.1.2</span> <em>climateData</em> module:</a></li>
  </ul>
</li>
  <li><a href="#prediction-module" id="toc-prediction-module" class="nav-link" data-scroll-target="#prediction-module"><span class="header-section-number">2.2.2</span> Prediction module</a></li>
  <li><a href="#additional-module-scripts-and-functions" id="toc-additional-module-scripts-and-functions" class="nav-link" data-scroll-target="#additional-module-scripts-and-functions"><span class="header-section-number">2.2.3</span> Additional module scripts and functions</a></li>
  </ul>
</li>
  <li>
<a href="#running-the-model" id="toc-running-the-model" class="nav-link" data-scroll-target="#running-the-model"><span class="header-section-number">2.3</span> Running the model</a>
  <ul>
<li><a href="#ensuring-all-packages-are-installed" id="toc-ensuring-all-packages-are-installed" class="nav-link" data-scroll-target="#ensuring-all-packages-are-installed"><span class="header-section-number">2.3.1</span> Ensuring all packages are installed</a></li>
  <li><a href="#simulation-set-up" id="toc-simulation-set-up" class="nav-link" data-scroll-target="#simulation-set-up"><span class="header-section-number">2.3.2</span> Simulation set-up</a></li>
  <li>
<a href="#simulation-runs" id="toc-simulation-runs" class="nav-link" data-scroll-target="#simulation-runs"><span class="header-section-number">2.3.3</span> Simulation runs</a>
  <ul class="collapse">
<li><a href="#adding-a-new-climate-scenario" id="toc-adding-a-new-climate-scenario" class="nav-link" data-scroll-target="#adding-a-new-climate-scenario"><span class="header-section-number">2.3.3.1</span> Adding a new climate scenario</a></li>
  <li><a href="#proposed-exercises" id="toc-proposed-exercises" class="nav-link" data-scroll-target="#proposed-exercises"><span class="header-section-number">2.3.3.2</span> Proposed exercises</a></li>
  <li><a href="#making-use-of-simlist-for-reporting" id="toc-making-use-of-simlist-for-reporting" class="nav-link" data-scroll-target="#making-use-of-simlist-for-reporting"><span class="header-section-number">2.3.3.3</span> Making use of <code>simList</code> for reporting</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#caching" id="toc-caching" class="nav-link" data-scroll-target="#caching"><span class="header-section-number">2.4</span> Caching</a>
  <ul>
<li><a href="#explicitly-caching-operations" id="toc-explicitly-caching-operations" class="nav-link" data-scroll-target="#explicitly-caching-operations"><span class="header-section-number">2.4.1</span> Explicitly caching operations</a></li>
  <li><a href="#implicit-caching-of-events" id="toc-implicit-caching-of-events" class="nav-link" data-scroll-target="#implicit-caching-of-events"><span class="header-section-number">2.4.2</span> Implicit caching of events</a></li>
  <li><a href="#controlling-caching-without-changing-module-code" id="toc-controlling-caching-without-changing-module-code" class="nav-link" data-scroll-target="#controlling-caching-without-changing-module-code"><span class="header-section-number">2.4.3</span> Controlling caching without changing module code</a></li>
  </ul>
</li>
  <li>
<a href="#best-practices" id="toc-best-practices" class="nav-link" data-scroll-target="#best-practices"><span class="header-section-number">2.5</span> Best practices</a>
  <ul>
<li><a href="#reproducible-package-installation" id="toc-reproducible-package-installation" class="nav-link" data-scroll-target="#reproducible-package-installation"><span class="header-section-number">2.5.1</span> Reproducible package installation</a></li>
  <li><a href="#protect-yourself-and-others-from-common-mistakesproblems" id="toc-protect-yourself-and-others-from-common-mistakesproblems" class="nav-link" data-scroll-target="#protect-yourself-and-others-from-common-mistakesproblems"><span class="header-section-number">2.5.2</span> Protect yourself and others from common mistakes/problems</a></li>
  <li><a href="#readable-code" id="toc-readable-code" class="nav-link" data-scroll-target="#readable-code"><span class="header-section-number">2.5.3</span> Readable code</a></li>
  <li><a href="#module-documentation-module-.rmd" id="toc-module-documentation-module-.rmd" class="nav-link" data-scroll-target="#module-documentation-module-.rmd"><span class="header-section-number">2.5.4</span> Module documentation – module <code>.Rmd</code></a></li>
  <li><a href="#coding-for-the-future" id="toc-coding-for-the-future" class="nav-link" data-scroll-target="#coding-for-the-future"><span class="header-section-number">2.5.5</span> Coding for the future</a></li>
  <li><a href="#transparent-models" id="toc-transparent-models" class="nav-link" data-scroll-target="#transparent-models"><span class="header-section-number">2.5.6</span> Transparent models</a></li>
  </ul>
</li>
  <li><a href="#additional-notes" id="toc-additional-notes" class="nav-link" data-scroll-target="#additional-notes"><span class="header-section-number">2.6</span> Additional notes</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-part2" class="quarto-section-identifier"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A more realistic example of <code>SpaDES</code></span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>Authors: Ceres Barros, Alex M. Chubaty</p>
<p>In <a href="./Part1_DummyModel.html">Chapter 1</a> of this guide, we described how to create new <code>SpaDES</code> modules, their different components, how to link different modules and how to set up and run a simulation.</p>
<p>Here, we assume that you are familiar with these steps, but go further in showing important <code>SpaDES</code> features that facilitate many of the steps common to most ecological modelling exercises. For the sake of simplicity, we focus our example on projecting a species’ distribution as a function of climate covariates. Yet, the true power of <code>SpaDES</code> is more evident when using complex dynamic simulation models parametrised using large datasets and ran across large spatial areas.</p>
<p>This example is broken into four main parts: <a href="#module-creation-and-coding">Module creation and coding</a>; <a href="#running-the-model">Running the model</a>; <a href="#caching">Caching</a>; and <a href="#best-practices">Best practices</a>. By no means does it cover caching or best practices in full, as each of these topics is very extensive, but it highlights some of their essentials in <code>SpaDES</code> and from our own experience.<br></p>
<p><br>
The full R script used to run the example can be found in <a href="appendices/Part2_Rscript.html" class="quarto-xref"><span>Appendix&nbsp;B</span></a> .</p>
<section id="the-example-projecting-species-distribution-shifts-under-climate-change" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="the-example-projecting-species-distribution-shifts-under-climate-change">
<span class="header-section-number">2.1</span> The example: projecting species distribution shifts under climate change</h2>
<p>Species distribution models (SDMs) have been widely used in ecology to predict how species presences and absences across a landscape may change under changing environmental conditions. As a result, there are several R packages that have been built with this in mind <span class="citation" data-cites="dismo biomod2">[e.g. `dismo` @dismo; `biomod2` @biomod2]</span> and many ecologists do these analyses exclusively in R.</p>
<p>Often, these analyses are run only once for a given set of species, baseline and projected environmental conditions, and researchers will have a few R scripts (or maybe just one longer script) that load the data into R, do any necessary pre-processing steps, fit the models and run species distribution projections. The usefulness of <code>SpaDES</code> comes when we want an automated and standardized workflow that can be easily updated with new data and adapted with new algorithms. <code>SpaDES</code> provides a common standard and a modular approach to modelling that facilitates expanding, debugging and sharing code, but also various tools that bring many well-known best practices from computer- and data-science workflows (including reproducible, modular workflows, and caching), to the realm of ecological modelling, so that they can be used by non-computer-scientists with minimal learning. In an SDM project this means that updating data and algorithms, and automating iterative forecasting become easier and less prone to errors. When <code>SpaDES</code> modules are open and shared, this also expands a potential pool of users who can themselves help improve the code.</p>
<hr></section><section id="module-creation-and-coding" class="level2" data-number="2.2"><h2 data-number="2.2" class="anchored" data-anchor-id="module-creation-and-coding">
<span class="header-section-number">2.2</span> Module creation and coding</h2>
<p>With the above in mind, in this example we created three modules that source and pre-process data (‘data modules’) and a module that fits an SDM and iteratively forecasts species distributions (we call it a ‘simulation module’, although the simulation only involves predicting from a statistical model). The idea is that we could, for instance, provide different data sources to one of the data modules and only update the parts of the simulation that are affected by this change (i.e.&nbsp;presumably the other data module steps with not be affected). Or, we could develop a second simulation module using a different SDM approach and swap the two modules to inspect which provides better predictions.</p>
<p>Our data modules are <em>speciesAbundanceData</em> and <em>climateData</em>. The simulation module is <em>projectSpeciesDist</em>. We start by creating an <code>.R</code> script to set up and control the simulation. In this example this script is called <code>Part2_SDMs.R</code>.</p>
<p>The script begins with a few lines of code that ensure a few packages are installed and loaded (see <a href="#reproducible-package-installation">Reproducible package installation</a>). It then defines the necessary folder directories for the simulation and creates the modules in the <code>modules/</code> folder.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"https://predictiveecology.r-universe.dev/"</span>, </span>
<span>                  CRAN <span class="op">=</span> <span class="st">"https://cloud.r-project.org"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric_version.html">getRversion</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&lt;</span> <span class="st">"4.2.1"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"dismo::maxent may create a fatal error"</span>,</span>
<span>                <span class="st">"when using R version &lt; v4.2.1 and from RStudio.\n"</span>, </span>
<span>                <span class="st">"Please upgrade R, or run this script outside of RStudio.\n"</span>,</span>
<span>                <span class="st">"See https://github.com/rspatial/dismo/issues/13"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## decide where you're working</span></span>
<span><span class="va">mainPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"~/SpaDES4Dummies_Part2"</span><span class="op">)</span></span>
<span><span class="va">pkgPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">mainPath</span>, <span class="st">"packages"</span>, <span class="va">version</span><span class="op">$</span><span class="va">platform</span>,</span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">version</span><span class="op">$</span><span class="va">major</span>, <span class="st">"."</span>, <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">version</span><span class="op">$</span><span class="va">minor</span>, <span class="st">"[.]"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">pkgPath</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="va">pkgPath</span>, include.site <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co">## install packages in project library (proj-lib)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="st">"remotes"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span>lib.loc <span class="op">=</span> <span class="va">pkgPath</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="st">"Require"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span>lib.loc <span class="op">=</span> <span class="va">pkgPath</span><span class="op">)</span> <span class="op">||</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"Require"</span>, lib.loc <span class="op">=</span> <span class="va">pkgPath</span><span class="op">)</span> <span class="op">&lt;</span> <span class="st">"0.3.1.9015"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"PredictiveEcology/Require@2788b023ad191c29346ef8c64df71b937be307e2"</span>,</span>
<span>                          upgrade <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Notes: </span></span>
<span><span class="co">## 1) if you are working from RStudio and have an older version of base packages like `Rcpp`, `rlang` </span></span>
<span><span class="co">## (and others) installed, you may  need to run the following lines (and code above) directly from R</span></span>
<span><span class="co">## in order to update these base packages</span></span>
<span><span class="co">## 2) Please ensure the appropriate Rtools version is installed (see)</span></span>
<span></span>
<span><span class="co">## there seems to be a problem with `ragg` and a forced install solves it</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="st">"ragg"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span>lib.loc <span class="op">=</span> <span class="va">pkgPath</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"ragg"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">Require</span><span class="fu">::</span><span class="fu"><a href="https://Require.predictiveecology.org/reference/Require.html">Require</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PredictiveEcology/SpaDES.project@transition (HEAD)"</span>, </span>
<span>                   <span class="st">"PredictiveEcology/SpaDES.core@master (HEAD)"</span>,</span>
<span>                   <span class="co">## these will be needed later on:</span></span>
<span>                   <span class="st">"ggpubr"</span>,</span>
<span>                   <span class="st">"geodata"</span>,</span>
<span>                   <span class="st">"SpaDES.tools"</span>,</span>
<span>                   <span class="st">"PredictiveEcology/SpaDES.experiment@75d917b70b892802fed0bbdb2a5e9f3c6772f0ba"</span><span class="op">)</span>,</span>
<span>                 require <span class="op">=</span> <span class="cn">FALSE</span>,  <span class="co">## don't load packages yet </span></span>
<span>                 upgrade <span class="op">=</span> <span class="cn">FALSE</span>, standAlone <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">Require</span><span class="fu">::</span><span class="fu"><a href="https://Require.predictiveecology.org/reference/Require.html">Require</a></span><span class="op">(</span><span class="st">"SpaDES.core"</span>, install <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co">## load only</span></span>
<span><span class="fu">setPaths</span><span class="op">(</span>cachePath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">mainPath</span>, <span class="st">"cache"</span><span class="op">)</span>,</span>
<span>         inputPath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">mainPath</span>, <span class="st">"inputs"</span><span class="op">)</span>,</span>
<span>         modulePath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">mainPath</span>, <span class="st">"modules"</span><span class="op">)</span>,</span>
<span>         outputPath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">mainPath</span>, <span class="st">"outputs"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simPaths</span> <span class="op">&lt;-</span> <span class="fu">getPaths</span><span class="op">(</span><span class="op">)</span> <span class="co">## check that this is what you wanted</span></span>
<span></span>
<span><span class="co">## Let's create a self-contained module that will simulate the species' abundance for any given period of time and frequency.</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">simPaths</span><span class="op">$</span><span class="va">modulePath</span>, <span class="st">"speciesAbundanceData"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">newModule</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"speciesAbundanceData"</span>, path <span class="op">=</span> <span class="va">simPaths</span><span class="op">$</span><span class="va">modulePath</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">simPaths</span><span class="op">$</span><span class="va">modulePath</span>, <span class="st">"climateData"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">newModule</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"climateData"</span>, path <span class="op">=</span> <span class="va">simPaths</span><span class="op">$</span><span class="va">modulePath</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">simPaths</span><span class="op">$</span><span class="va">modulePath</span>, <span class="st">"projectSpeciesDist"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">newModule</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"projectSpeciesDist"</span>, path <span class="op">=</span> <span class="va">simPaths</span><span class="op">$</span><span class="va">modulePath</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Notice how we protect the <code>newModule</code> call with an <code>if</code> statement that first detects whether the module directory exists already. This is necessary to prevent overwriting existing modules should this script be run a second time in the same location (see <a href="#protect-yourself-and-others-from-common-mistakesproblems">Protect yourself and others from common mistakes/problems</a>).</p>
<p><code>setPaths</code> will create the project folder directories in case they do not exist (no overwriting occurs in case they do).</p>
<p>Finally, note that we do not load any R packages yet, as we will later use <code>Require</code> to make sure all module dependencies are installed before running the simulation (see <a href="#reproducible-package-installation">Reproducible package installation</a>). Because <code>Require</code> may attempt to install missing packages and because installing packages should be done in a clean R session, we will only load any packages after all the installation steps are complete.</p>
<section id="data-modules" class="level3" data-number="2.2.1"><h3 data-number="2.2.1" class="anchored" data-anchor-id="data-modules">
<span class="header-section-number">2.2.1</span> Data modules</h3>
<p>The next two sections show our two data modules <code>.R</code> scripts. We assume you are already familiar with the different parts of a module <code>.R</code> script; if not, see <a href="./Part1_DummyModel.html">Chapter 1</a>. We do not discuss the module <code>.Rmd</code> files, which should document each module in detail (see [Module documentation – module .Rmd]).</p>
<section id="speciesabundancedata-module" class="level4" data-number="2.2.1.1"><h4 data-number="2.2.1.1" class="anchored" data-anchor-id="speciesabundancedata-module">
<span class="header-section-number">2.2.1.1</span> <em>speciesAbundanceData</em> module:</h4>
<p>This module downloads freely available spatial layers of <em>Picea glauca</em> percent cover (% cover) across Canada and pre-processes them to match a user-supplied study area raster. We use the new <code>terra</code> package throughout this example, since the <code>raster</code> package will soon be discontinued.</p>
<p>The <code>prepInputs</code> function downloads the % cover layer from the Canadian National Forest Inventory data server using the URL supplied by <code>sppAbundURL</code> and processes it to match the study area raster (<code>studyAreaRas</code>) supplied by the user. The module then outputs <em>Picea glauca</em> % cover as a raster (<code>sppAbundanceRas</code>) and as a <code>data.table</code> (<code>sppAbundanceDT</code>). The <code>data.table</code> contains added information about the year of the simulation during which the data should be used (here, only the first year when SDM fitting happens).</p>
<p>We export species % cover in two formats (a raster and a table) for demonstrational purposes, but also because we could envision that this model (i.e.&nbsp;group of modules) could save the species distribution projections for several points in time in a more compact format of a <code>data.table</code> – large raster layers can consume a considerable amount of disk space (see <a href="#coding-for-the-future">Coding for the future</a>).</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/dataModule1_5840d1fd493d9e71e45d9761eaaf0e18">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Everything in this file and any files in the R directory are sourced during `simInit()`;</span></span>
<span><span class="co">## all functions and objects are put into the `simList`.</span></span>
<span><span class="co">## To use objects, use `sim$xxx` (they are globally available to all modules).</span></span>
<span><span class="co">## Functions can be used inside any function that was sourced in this module;</span></span>
<span><span class="co">## they are namespaced to the module, just like functions in R packages.</span></span>
<span><span class="co">## If exact location is required, functions will be: `sim$.mods$&lt;moduleName&gt;$FunctionName`.</span></span>
<span><span class="fu">defineModule</span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"speciesAbundanceData"</span>,</span>
<span>  description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Data module to prepare tree species cover data for species distribution modelling."</span>, </span>
<span>                      <span class="st">"Defaults to using Canadian National Forest Inventory data."</span><span class="op">)</span>,</span>
<span>  keywords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"minimal SpaDES example"</span>, <span class="st">"species distribution model"</span><span class="op">)</span>,</span>
<span>  authors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>given <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ceres"</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"Barros"</span>, role <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"aut"</span>, <span class="st">"cre"</span><span class="op">)</span>, </span>
<span>                                email <span class="op">=</span> <span class="st">"ceres.barros@ubc.ca"</span>, comment <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"person"</span><span class="op">)</span>,</span>
<span>  childModules <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>  version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>speciesAbundanceData <span class="op">=</span> <span class="st">"1.0.0"</span><span class="op">)</span>,</span>
<span>  timeframe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXlt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  timeunit <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  citation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"citation.bib"</span><span class="op">)</span>,</span>
<span>  documentation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"README.md"</span>, <span class="st">"speciesAbundanceData.Rmd"</span><span class="op">)</span>, <span class="co">## same file</span></span>
<span>  reqdPkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"SpaDES.core (&gt;=2.0.2)"</span>,</span>
<span>                  <span class="st">"httr"</span>, <span class="st">"terra"</span>, <span class="st">"ggplot2"</span>, <span class="st">"rasterVis"</span><span class="op">)</span>,</span>
<span>  parameters <span class="op">=</span> <span class="fu">bindrows</span><span class="op">(</span></span>
<span>    <span class="co">#defineParameter("paramName", "paramClass", value, min, max, "parameter description"),</span></span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">"sppAbundURL"</span>, <span class="st">"character"</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://ftp.maps.canada.ca/pub/nrcan_rncan/Forests_Foret/"</span>,</span>
<span>                           <span class="st">"canada-forests-attributes_attributs-forests-canada/"</span>,</span>
<span>                           <span class="st">"2001-attributes_attributs-2001/"</span>,</span>
<span>                           <span class="st">"NFI_MODIS250m_2001_kNN_Species_Pice_Gla_v1.tif"</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"URL where the first SpatRaster of species abundance resides."</span>,</span>
<span>                          <span class="st">"This will be the abundance data used to fit the species ditribution model."</span>,</span>
<span>                          <span class="st">"Defaults to *Picea glauca* percent cover across Canada, in 2001"</span>, </span>
<span>                          <span class="st">"(from Canadian National Forest Inventory forest attributes)"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".plots"</span>, <span class="st">"character"</span>, <span class="st">"screen"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Used by Plots function, which can be optionally used here"</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".plotInitialTime"</span>, <span class="st">"numeric"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/start.html">start</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Describes the simulation time at which the first plot event should occur."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".plotInterval"</span>, <span class="st">"numeric"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Describes the simulation time interval between plot events."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".saveInitialTime"</span>, <span class="st">"numeric"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Describes the simulation time at which the first save event should occur."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".saveInterval"</span>, <span class="st">"numeric"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"This describes the simulation time interval between save events."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".studyAreaName"</span>, <span class="st">"character"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Human-readable name for the study area used. If NA, a hash of studyArea will be used."</span><span class="op">)</span>,</span>
<span>    <span class="co">## .seed is optional: `list('init' = 123)` will `set.seed(123)` for the `init` event only.</span></span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".seed"</span>, <span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Named list of seeds to use for each event (names)."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".useCache"</span>, <span class="st">"logical"</span>, <span class="cn">FALSE</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Should caching of events or module be used?"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  inputObjects <span class="op">=</span> <span class="fu">bindrows</span><span class="op">(</span></span>
<span>    <span class="co">#expectsInput("objectName", "objectClass", "input object description", sourceURL, ...),</span></span>
<span>    <span class="fu">expectsInput</span><span class="op">(</span><span class="st">"studyAreaRas"</span>, objectClass <span class="op">=</span> <span class="st">"SpatRaster"</span>, </span>
<span>                 desc <span class="op">=</span> <span class="st">"A binary raster of the study area"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  outputObjects <span class="op">=</span> <span class="fu">bindrows</span><span class="op">(</span></span>
<span>    <span class="co">#createsOutput("objectName", "objectClass", "output object description", ...),</span></span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span><span class="st">"sppAbundanceDT"</span>, <span class="st">"data.table"</span>, </span>
<span>                  desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Species abundance data from `sppAbundanceRas`, with columns 'cell',"</span>,</span>
<span>                               <span class="st">"'x', 'y', 'sppAbund' and 'year' (an integer matching the number in"</span>,</span>
<span>                               <span class="st">"names(`sppAbundanceRas`)."</span> <span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span><span class="st">"sppAbundanceRas"</span>, <span class="st">"SpatRaster"</span>, </span>
<span>                  desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"A species abundance layer used to fit a species distribution model"</span>,</span>
<span>                               <span class="st">"at the start of the simulation. Layers named as:"</span>,</span>
<span>                               <span class="st">"paste('year', start(sim):end(sim), sep = '_')). Data obtained from"</span>,</span>
<span>                               <span class="st">"P(sim)$sppAbundURL"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## event types</span></span>
<span><span class="co">#   - type `init` is required for initialization</span></span>
<span></span>
<span><span class="va">doEvent.speciesAbundanceData</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span>, <span class="va">eventTime</span>, <span class="va">eventType</span>, <span class="va">debug</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span></span>
<span>    <span class="va">eventType</span>,</span>
<span>    init <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co">## do stuff for this event</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">abundanceInit</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co">## schedule future event(s)</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">scheduleEvent</span><span class="op">(</span><span class="va">sim</span>, eventTime <span class="op">=</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">.plotInitialTime</span>, </span>
<span>                           moduleName <span class="op">=</span> <span class="st">"speciesAbundanceData"</span>, eventType <span class="op">=</span> <span class="st">"abundPlot"</span>,</span>
<span>                           eventPriority <span class="op">=</span> <span class="fu">.normal</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    abundPlot <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co">## do stuff for this event</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">abundancePlot</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Undefined event type: '"</span>, <span class="fu">current</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"eventType"</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>                  <span class="st">"' in module '"</span>, <span class="fu">current</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"moduleName"</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="st">"'"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## event functions</span></span>
<span><span class="co">#   - keep event functions short and clean, modularize by calling subroutines from section below.</span></span>
<span></span>
<span><span class="co">## Initialisation Event function</span></span>
<span><span class="va">abundanceInit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## download data - prepInputs does all the heavy-lifting of dowloading and pre-processing the layer and caches.</span></span>
<span>  <span class="co">## there seems to be an issue masking this particular raster with `terra` and `GDAL`, so we'll not use them here.</span></span>
<span>  <span class="va">opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="st">"reproducible.useTerra"</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  <span class="st">"reproducible.useGDAL"</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>   </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">opts</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/with_config.html">with_config</a></span><span class="op">(</span>config <span class="op">=</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/config.html">config</a></span><span class="op">(</span>ssl_verifypeer <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span>, <span class="op">{</span></span>
<span>    <span class="va">sppAbundanceRas</span> <span class="op">&lt;-</span> <span class="fu">prepInputs</span><span class="op">(</span>targetFile <span class="op">=</span> <span class="st">"NFI_MODIS250m_2001_kNN_Species_Pice_Gla_v1.tif"</span>,</span>
<span>                                  url <span class="op">=</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">sppAbundURL</span>,</span>
<span>                                  <span class="co"># fun = "terra::rast",</span></span>
<span>                                  <span class="co"># projectTo = sim$studyAreaRas,</span></span>
<span>                                  <span class="co"># cropTo = sim$studyAreaRas,</span></span>
<span>                                  <span class="co"># maskTo = sim$studyAreaRas,</span></span>
<span>                                  rasterToMatch <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span><span class="op">)</span>,</span>
<span>                                  maskWithRTM <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                  cacheRepo <span class="op">=</span> <span class="fu">cachePath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">opts</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">is</span><span class="op">(</span><span class="va">sppAbundanceRas</span>, <span class="st">"RasterLayer"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sppAbundanceRas</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">sppAbundanceRas</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sppAbundanceRas</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span>  <span class="va">sppAbundanceDT</span> <span class="op">&lt;-</span> <span class="fu">as.data.table</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">sppAbundanceRas</span>, xy <span class="op">=</span> <span class="cn">TRUE</span>, cells <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sppAbundanceDT</span><span class="op">[</span>, <span class="va">year</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"year_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sppAbundanceRas</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu">setnames</span><span class="op">(</span><span class="va">sppAbundanceDT</span>, <span class="st">"year_1"</span>, <span class="st">"sppAbund"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## export to sim</span></span>
<span>  <span class="va">sim</span><span class="op">$</span><span class="va">sppAbundanceRas</span> <span class="op">&lt;-</span> <span class="va">sppAbundanceRas</span></span>
<span>  <span class="va">sim</span><span class="op">$</span><span class="va">sppAbundanceDT</span> <span class="op">&lt;-</span> <span class="va">sppAbundanceDT</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Plotting event function </span></span>
<span><span class="va">abundancePlot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## plot species abundance</span></span>
<span>  <span class="fu">Plots</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">sppAbundanceRas</span>, fn <span class="op">=</span> <span class="va">plotSpatRaster</span>, types <span class="op">=</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">.plots</span>,</span>
<span>        usePlot <span class="op">=</span> <span class="cn">TRUE</span>, filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu">outputPath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"figures"</span>, <span class="st">"speciesAbundance"</span><span class="op">)</span>, </span>
<span>        plotTitle <span class="op">=</span> <span class="st">"Species abundance data"</span>, xlab <span class="op">=</span> <span class="st">"Longitude"</span>, ylab <span class="op">=</span> <span class="st">"Latitude"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">.inputObjects</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#cacheTags &lt;- c(currentModule(sim), "function:.inputObjects") ## uncomment this if Cache is being used</span></span>
<span>  <span class="va">dPath</span> <span class="op">&lt;-</span> <span class="fu">asPath</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"reproducible.destinationPath"</span>, <span class="fu">dataPath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu">currentModule</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">": using dataPath '"</span>, <span class="va">dPath</span>, <span class="st">"'."</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">suppliedElsewhere</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">## code check: did the user supply a study area?</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Please supply a 'studyAreaRas' SpatRaster"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="climatedata-module" class="level4" data-number="2.2.1.2"><h4 data-number="2.2.1.2" class="anchored" data-anchor-id="climatedata-module">
<span class="header-section-number">2.2.1.2</span> <em>climateData</em> module:</h4>
<p>This module downloads and processes freely available spatial layers of four bioclimatic variables used to fit the SDM of <em>Picea glauca</em> in the study area.</p>
<p>The module uses a different way to download data. It relies on two input <code>data.tables</code> that contain the URLs for each climate covariate, one for baseline conditions, the other for projected climate conditions, both containing information about when each layer should be used during the simulation (the “year”column).</p>
<p>We have only supplied one set of data sources for default baseline climate conditions (<code>baselineClimateURLs</code>) and for climate projections (<code>projClimateURLs</code>), all of which are downloaded from WorldClim at 2.5 minutes resolution. The baseline climate data correspond to the 1970-2000 period <span class="citation" data-cites="FickHijmans2017">@FickHijmans2017</span>, which aligns well with the species % cover data year (2001). The climate projections were obtained for 2021-2040, 2041-2060, 2061-2080 and 2081-2100, from CMIP6 downscaled future projections using the CanESM5 model <span class="citation" data-cites="SwartEtAl2019">[@SwartEtAl2019]</span> under the SSP 585 climate scenario.</p>
<p>We encourage providing different (or additional) URLs referring to projections for other climate periods, other climate models and other climate scenarios (see <a href="https://www.worldclim.org/data/cmip6/cmip6climate.html">WorldClim</a> for a list of climate projections).</p>
<p>If providing other URLs to obtain different climate data, pay special attention to the “year” column of <code>projClimateURLs</code> – the URLs need to correspond to the simulation year during which they will be used (not necessarily the actual climate year, unless the simulation years follow the same numbering).</p>
<p>Like in the <code>speciesAbundanceData</code> module, the <code>prepInputs</code> function processes the climate layers to match the study area raster (<code>studyAreaRas</code>) and compiles all climate data in the <code>climateDT</code> object and as raster layer objects (<code>baselineClimateRas</code> and <code>projClimateRas</code>) – the module’s outputs.</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/dataModule2_76197e84a556158274342b915b92b152">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Everything in this file and any files in the R directory are sourced during `simInit()`;</span></span>
<span><span class="co">## all functions and objects are put into the `simList`.</span></span>
<span><span class="co">## To use objects, use `sim$xxx` (they are globally available to all modules).</span></span>
<span><span class="co">## Functions can be used inside any function that was sourced in this module;</span></span>
<span><span class="co">## they are namespaced to the module, just like functions in R packages.</span></span>
<span><span class="co">## If exact location is required, functions will be: `sim$.mods$&lt;moduleName&gt;$FunctionName`.</span></span>
<span><span class="fu">defineModule</span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"climateData"</span>,</span>
<span>  description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Data module to prepare climate data for species distribution modelling."</span>, </span>
<span>                      <span class="st">"Defaults to using bioclimatic variables from Worldclim."</span><span class="op">)</span>,</span>
<span>  keywords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"minimal SpaDES example"</span>, <span class="st">"species distribution model"</span><span class="op">)</span>,</span>
<span>  authors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>given <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ceres"</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"Barros"</span>, role <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"aut"</span>, <span class="st">"cre"</span><span class="op">)</span>, email <span class="op">=</span> <span class="st">"ceres.barros@ubc.ca"</span>, comment <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"person"</span><span class="op">)</span>,</span>
<span>  childModules <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>  version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>climateData <span class="op">=</span> <span class="st">"1.0.0"</span><span class="op">)</span>,</span>
<span>  timeframe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXlt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  timeunit <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  citation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"citation.bib"</span><span class="op">)</span>,</span>
<span>  documentation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"README.md"</span>, <span class="st">"climateData.Rmd"</span><span class="op">)</span>, <span class="co">## same file</span></span>
<span>  reqdPkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"SpaDES.core (&gt;=2.0.2)"</span>,</span>
<span>                  <span class="st">"ggplot2"</span>, <span class="st">"rasterVis"</span>, <span class="st">"terra"</span>, <span class="st">"data.table"</span><span class="op">)</span>,</span>
<span>  parameters <span class="op">=</span> <span class="fu">bindrows</span><span class="op">(</span></span>
<span>    <span class="co">#defineParameter("paramName", "paramClass", value, min, max, "parameter description"),</span></span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".plots"</span>, <span class="st">"character"</span>, <span class="st">"screen"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Used by Plots function, which can be optionally used here"</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".plotInitialTime"</span>, <span class="st">"numeric"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/start.html">start</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Describes the simulation time at which the first plot event should occur."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".plotInterval"</span>, <span class="st">"numeric"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Describes the simulation time interval between plot events."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".saveInitialTime"</span>, <span class="st">"numeric"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Describes the simulation time at which the first save event should occur."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".saveInterval"</span>, <span class="st">"numeric"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"This describes the simulation time interval between save events."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".studyAreaName"</span>, <span class="st">"character"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Human-readable name for the study area used. If NA, a hash of studyArea will be used."</span><span class="op">)</span>,</span>
<span>    <span class="co">## .seed is optional: `list('init' = 123)` will `set.seed(123)` for the `init` event only.</span></span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".seed"</span>, <span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Named list of seeds to use for each event (names)."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".useCache"</span>, <span class="st">"logical"</span>, <span class="cn">FALSE</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Should caching of events or module be used?"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  inputObjects <span class="op">=</span> <span class="fu">bindrows</span><span class="op">(</span></span>
<span>    <span class="co">#expectsInput("objectName", "objectClass", "input object description", sourceURL, ...),</span></span>
<span>    <span class="fu">expectsInput</span><span class="op">(</span><span class="st">"baselineClimateURLs"</span>, <span class="st">"data.table"</span>, </span>
<span>                 desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"A table with columns 'vars', 'URL', 'targetFile' and 'year', containing"</span>,</span>
<span>                              <span class="st">"variable names, URLs and raster file names of each climate covariate"</span>,</span>
<span>                              <span class="st">"used in the species distribution models. Year is the first year of the"</span>, </span>
<span>                              <span class="st">"simulation (not the reference climate period). Defaults to Worldclim's"</span>,</span>
<span>                              <span class="st">"'bio1', 'bio4', 'bio12' and 'bio15' bioclimatic variables for the 1970-2000"</span>,</span>
<span>                              <span class="st">"climate period, at 2.5 minutes."</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">expectsInput</span><span class="op">(</span><span class="st">"projClimateURLs"</span>, <span class="st">"data.table"</span>, </span>
<span>                 desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Same as `baselineClimateURLs` but refering to projected climate layers."</span>,</span>
<span>                              <span class="st">"Variable names in 'vars' need to the same as in `baselineClimateURLs`"</span>,</span>
<span>                              <span class="st">"and P(sim)$projClimateURLs. Years should correspond to simulation years."</span>,</span>
<span>                              <span class="st">"Defaults to 2081-2100 projections using the CanESM5 climate model and the"</span>,</span>
<span>                              <span class="st">"SSP 585 climate scenario, at 2.5 minutes, obtained from Worldclim."</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">expectsInput</span><span class="op">(</span><span class="st">"studyAreaRas"</span>, objectClass <span class="op">=</span> <span class="st">"SpatRaster"</span>, </span>
<span>                 desc <span class="op">=</span> <span class="st">"A binary raster of the study area"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  outputObjects <span class="op">=</span> <span class="fu">bindrows</span><span class="op">(</span></span>
<span>    <span class="co">#createsOutput("objectName", "objectClass", "output object description", ...),</span></span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span><span class="st">"climateDT"</span>, <span class="st">"data.table"</span>, </span>
<span>                  desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"A data.table with as many columns as the climate covariates"</span>, </span>
<span>                               <span class="st">"used in the species distribution model and 'year' column describing"</span>,</span>
<span>                               <span class="st">"the simulation year to which the data corresponds."</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span><span class="st">"baselineClimateRas"</span>, <span class="st">"SpatRaster"</span>, </span>
<span>                  desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Baseline climate layers obtained from `baselineClimateURLs`"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span><span class="st">"projClimateRas"</span>, <span class="st">"SpatRaster"</span>, </span>
<span>                  desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Baseline climate layers obtained from `projClimateURLs`"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## event types</span></span>
<span><span class="co">#   - type `init` is required for initialization</span></span>
<span></span>
<span><span class="va">doEvent.climateData</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span>, <span class="va">eventTime</span>, <span class="va">eventType</span>, <span class="va">debug</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span></span>
<span>    <span class="va">eventType</span>,</span>
<span>    init <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co">## do stuff for this event</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">climateInit</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co">## schedule future event(s)</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">scheduleEvent</span><span class="op">(</span><span class="va">sim</span>, eventTime <span class="op">=</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">.plotInitialTime</span>, </span>
<span>                           moduleName <span class="op">=</span> <span class="st">"climateData"</span>, eventType <span class="op">=</span> <span class="st">"climPlot"</span>,</span>
<span>                           eventPriority <span class="op">=</span> <span class="fu">.normal</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    climPlot <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co">## do stuff for this event</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">climatePlot</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Undefined event type: '"</span>, <span class="fu">current</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"eventType"</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>                  <span class="st">"' in module '"</span>, <span class="fu">current</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"moduleName"</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="st">"'"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## event functions</span></span>
<span><span class="co">#   - keep event functions short and clean, modularize by calling subroutines from section below.</span></span>
<span></span>
<span><span class="co">## Initialisation Event function</span></span>
<span><span class="va">climateInit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## GET BASELINE DATA</span></span>
<span>  <span class="co">## make a vector of archive (zip) file names if the url points to one.</span></span>
<span>  <span class="va">archiveFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span><span class="op">$</span><span class="va">URL</span>, <span class="kw">function</span><span class="op">(</span><span class="va">URL</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"\\.zip$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">URL</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">URL</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="cn">NULL</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>, USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## check that baseline climate data only has one year value</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"'baselineClimateURLs' should all have the same 'year' value,"</span>,</span>
<span>               <span class="st">"corresponding to the first year of the simulation"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">## download data - prepInputs does all the heavy-lifting of dowloading and pre-processing the layer and caches.</span></span>
<span>  <span class="va">baselineClimateRas</span> <span class="op">&lt;-</span> <span class="fu">Cache</span><span class="op">(</span><span class="va">Map</span>, </span>
<span>                              f <span class="op">=</span> <span class="va">prepInputs</span>,</span>
<span>                              url <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span><span class="op">$</span><span class="va">URL</span>,</span>
<span>                              targetFile <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span><span class="op">$</span><span class="va">targetFile</span>,</span>
<span>                              archive <span class="op">=</span> <span class="va">archiveFiles</span>,</span>
<span>                              MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>                                fun <span class="op">=</span> <span class="st">"terra::rast"</span>,</span>
<span>                                overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                projectTo <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>,</span>
<span>                                cropTo <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>,</span>
<span>                                maskTo <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>,</span>
<span>                                rasterToMatch <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>,</span>
<span>                                cacheRepo <span class="op">=</span> <span class="fu">cachePath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              cacheRepo <span class="op">=</span> <span class="fu">cachePath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">baselineClimateRas</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span><span class="op">$</span><span class="va">vars</span>, <span class="st">"_year"</span>, <span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## make a stack</span></span>
<span>  <span class="va">baselineClimateRas</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">baselineClimateRas</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## make a data.table </span></span>
<span>  <span class="va">baselineClimateData</span> <span class="op">&lt;-</span> <span class="fu">as.data.table</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">baselineClimateRas</span>, xy <span class="op">=</span> <span class="cn">TRUE</span>, cells <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">setnames</span><span class="op">(</span><span class="va">baselineClimateData</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"_year.*"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">baselineClimateData</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co">## don't need year in names here </span></span>
<span>  <span class="va">baselineClimateData</span><span class="op">[</span>, <span class="va">year</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co">## GET PROJECTED DATA</span></span>
<span>  <span class="co">## make a vector of archive (zip) file names if the url points to one.</span></span>
<span>  <span class="va">archiveFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">projClimateURLs</span><span class="op">$</span><span class="va">URL</span>, <span class="kw">function</span><span class="op">(</span><span class="va">URL</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"\\.zip$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">URL</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">URL</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="cn">NULL</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## download data - prepInputs does all the heavy-lifting of dowloading and pre-processing the layer and caches.</span></span>
<span>  <span class="co">## workaround Mar 30th 2022 cache issue with terra.</span></span>
<span>  <span class="va">projClimateRas</span> <span class="op">&lt;-</span> <span class="fu">Cache</span><span class="op">(</span><span class="va">Map</span>, </span>
<span>                          f <span class="op">=</span> <span class="va">prepInputs</span>,</span>
<span>                          url <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">projClimateURLs</span><span class="op">$</span><span class="va">URL</span>,</span>
<span>                          targetFile <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">projClimateURLs</span><span class="op">$</span><span class="va">targetFile</span>,</span>
<span>                          archive <span class="op">=</span> <span class="va">archiveFiles</span>,</span>
<span>                          MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>                            overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            fun <span class="op">=</span> <span class="st">"raster::stack"</span>,</span>
<span>                            projectTo <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>,</span>
<span>                            cropTo <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>,</span>
<span>                            maskTo <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>,</span>
<span>                            rasterToMatch <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>,</span>
<span>                            cacheRepo <span class="op">=</span> <span class="fu">cachePath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                          cacheRepo <span class="op">=</span> <span class="fu">cachePath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">projClimateRas</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">is</span><span class="op">(</span><span class="va">x</span>, <span class="st">"RasterLayer"</span><span class="op">)</span> <span class="op">|</span> <span class="fu">is</span><span class="op">(</span><span class="va">x</span>, <span class="st">"RasterStack"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">projClimateRas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">projClimateRas</span>, <span class="fu">terra</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">## these rasters are different. The tif file contains all the variables in different layers</span></span>
<span>  <span class="co">## so, for each variable, we need to keep only the layer of interest</span></span>
<span>  <span class="va">projClimateRas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">stk</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lyr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">".*_"</span>, <span class="st">"BIO"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">projClimateRas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="va">var</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">stk</span><span class="op">[[</span><span class="va">lyr</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, stk <span class="op">=</span> <span class="va">projClimateRas</span>, var <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">projClimateURLs</span><span class="op">$</span><span class="va">vars</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">projClimateRas</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">projClimateURLs</span><span class="op">$</span><span class="va">vars</span>, <span class="st">"_year"</span>, <span class="va">sim</span><span class="op">$</span><span class="va">projClimateURLs</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## make a stack</span></span>
<span>  <span class="va">projClimateRas</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">projClimateRas</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## make a data.table </span></span>
<span>  <span class="va">projClimateData</span> <span class="op">&lt;-</span> <span class="fu">as.data.table</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">projClimateRas</span>, xy <span class="op">=</span> <span class="cn">TRUE</span>, cells <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## melt so that year is in a column</span></span>
<span>  <span class="va">projClimateDataMolten</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">projClimateURLs</span><span class="op">$</span><span class="va">vars</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">var</span>, <span class="va">projClimateData</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">"_year"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">projClimateData</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">idCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">projClimateData</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"_year"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">projClimateData</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">moltenDT</span> <span class="op">&lt;-</span>  <span class="fu">melt</span><span class="op">(</span><span class="va">projClimateData</span>, id.vars <span class="op">=</span> <span class="va">idCols</span>, measure.vars <span class="op">=</span> <span class="va">cols</span>, </span>
<span>                      variable.name <span class="op">=</span> <span class="st">"year"</span>, value.name <span class="op">=</span> <span class="va">var</span><span class="op">)</span></span>
<span>    <span class="va">moltenDT</span><span class="op">[</span>, <span class="va">year</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">"_year"</span><span class="op">)</span>, <span class="st">""</span>, <span class="va">year</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">moltenDT</span><span class="op">[</span>, <span class="va">year</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">moltenDT</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, projClimateData <span class="op">=</span> <span class="va">projClimateData</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">idCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">projClimateData</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"_year"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">projClimateData</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, <span class="st">"year"</span><span class="op">)</span></span>
<span>  <span class="co">## set keys for merge</span></span>
<span>  <span class="va">projClimateDataMolten</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">projClimateDataMolten</span>, <span class="kw">function</span><span class="op">(</span><span class="va">DT</span>, <span class="va">cols</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">setkeyv</span><span class="op">(</span><span class="va">DT</span>, cols <span class="op">=</span> <span class="va">cols</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">DT</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, cols <span class="op">=</span> <span class="va">idCols</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">projClimateData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span><span class="op">(</span><span class="va">merge</span>, <span class="va">projClimateDataMolten</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## bind the two data.tables</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">baselineClimateData</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">projClimateData</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Variable names in `projClimateURLs` differ from those in `baselineClimateURLs`"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">## check</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">compareGeom</span><span class="op">(</span><span class="va">baselineClimateRas</span>, <span class="va">projClimateRas</span>, res <span class="op">=</span> <span class="cn">TRUE</span>, stopOnError <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"`baselineClimateRas` and `projClimateRas` do not have the same raster properties"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">## export to sim</span></span>
<span>  <span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateRas</span> <span class="op">&lt;-</span> <span class="va">baselineClimateRas</span></span>
<span>  <span class="va">sim</span><span class="op">$</span><span class="va">projClimateRas</span> <span class="op">&lt;-</span> <span class="va">projClimateRas</span></span>
<span>  <span class="va">sim</span><span class="op">$</span><span class="va">climateDT</span> <span class="op">&lt;-</span> <span class="fu">rbindlist</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">baselineClimateData</span>, <span class="va">projClimateData</span><span class="op">)</span>, use.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Plotting event function </span></span>
<span><span class="va">climatePlot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## plot climate rasters </span></span>
<span>  <span class="va">allRasters</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateRas</span>, <span class="va">sim</span><span class="op">$</span><span class="va">projClimateRas</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span><span class="op">$</span><span class="va">vars</span>, <span class="kw">function</span><span class="op">(</span><span class="va">var</span>, <span class="va">allRasters</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">"_"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">allRasters</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"climateRas_"</span>, <span class="va">var</span><span class="op">)</span></span>
<span>    <span class="fu">Plots</span><span class="op">(</span><span class="va">allRasters</span><span class="op">[[</span><span class="va">lrs</span><span class="op">]</span><span class="op">]</span>,</span>
<span>          fn <span class="op">=</span> <span class="va">plotSpatRasterStk</span>, types <span class="op">=</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">.plots</span>,</span>
<span>          usePlot <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>          filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu">outputPath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"figures"</span>, <span class="va">file_name</span><span class="op">)</span>,</span>
<span>          xlab <span class="op">=</span> <span class="st">"Longitude"</span>, ylab <span class="op">=</span> <span class="st">"Latitude"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, allRasters <span class="op">=</span> <span class="va">allRasters</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">.inputObjects</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#cacheTags &lt;- c(currentModule(sim), "function:.inputObjects") ## uncomment this if Cache is being used</span></span>
<span>  <span class="va">dPath</span> <span class="op">&lt;-</span> <span class="fu">asPath</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"reproducible.destinationPath"</span>, <span class="fu">dataPath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu">currentModule</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">": using dataPath '"</span>, <span class="va">dPath</span>, <span class="st">"'."</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">suppliedElsewhere</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">## code check: did the user supply a study area?</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Please supply a 'studyAreaRas' SpatRaster"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">is</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>, <span class="st">"SpatRaster"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">suppliedElsewhere</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sim</span><span class="op">$</span><span class="va">baselineClimateURLs</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>      vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BIO1"</span>, <span class="st">"BIO4"</span>, <span class="st">"BIO12"</span>, <span class="st">"BIO15"</span><span class="op">)</span>,</span>
<span>      URL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"https://biogeo.ucdavis.edu/data/worldclim/v2.1/base/wc2.1_2.5m_bio.zip"</span>,</span>
<span>              <span class="st">"https://biogeo.ucdavis.edu/data/worldclim/v2.1/base/wc2.1_2.5m_bio.zip"</span>,</span>
<span>              <span class="st">"https://biogeo.ucdavis.edu/data/worldclim/v2.1/base/wc2.1_2.5m_bio.zip"</span>,</span>
<span>              <span class="st">"https://biogeo.ucdavis.edu/data/worldclim/v2.1/base/wc2.1_2.5m_bio.zip"</span><span class="op">)</span>,</span>
<span>      targetFile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wc2.1_2.5m_bio_1.tif"</span>, <span class="st">"wc2.1_2.5m_bio_4.tif"</span>, </span>
<span>                     <span class="st">"wc2.1_2.5m_bio_12.tif"</span>, <span class="st">"wc2.1_2.5m_bio_15.tif"</span><span class="op">)</span>,</span>
<span>      year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">4</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">suppliedElsewhere</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">projClimateURLs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sim</span><span class="op">$</span><span class="va">projClimateURLs</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>      vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BIO1"</span>, <span class="st">"BIO4"</span>, <span class="st">"BIO12"</span>, <span class="st">"BIO15"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>      URL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"https://geodata.ucdavis.edu/cmip6/2.5m/CanESM5/ssp585/wc2.1_2.5m_bioc_CanESM5_ssp585_2021-2040.tif"</span>,</span>
<span>                  <span class="st">"https://geodata.ucdavis.edu/cmip6/2.5m/CanESM5/ssp585/wc2.1_2.5m_bioc_CanESM5_ssp585_2041-2060.tif"</span>,</span>
<span>                  <span class="st">"https://geodata.ucdavis.edu/cmip6/2.5m/CanESM5/ssp585/wc2.1_2.5m_bioc_CanESM5_ssp585_2061-2080.tif"</span>,</span>
<span>                  <span class="st">"https://geodata.ucdavis.edu/cmip6/2.5m/CanESM5/ssp585/wc2.1_2.5m_bioc_CanESM5_ssp585_2081-2100.tif"</span><span class="op">)</span>,</span>
<span>                each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>      targetFile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wc2.1_2.5m_bioc_CanESM5_ssp585_2021-2040.tif"</span>,</span>
<span>                         <span class="st">"wc2.1_2.5m_bioc_CanESM5_ssp585_2041-2060.tif"</span>,</span>
<span>                         <span class="st">"wc2.1_2.5m_bioc_CanESM5_ssp585_2061-2080.tif"</span>,</span>
<span>                         <span class="st">"wc2.1_2.5m_bioc_CanESM5_ssp585_2081-2100.tif"</span><span class="op">)</span>,</span>
<span>                       each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>      year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">:</span><span class="fl">5L</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> </span>
<span>  </span>
<span>  <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We draw your attention to a few particular aspects of the data modules:</p>
<ul>
<li><p>How we took care to define the data classes of parameters, expected inputs and module outputs in their respective metadata sections;</p></li>
<li><p>How we added additional R packages necessary to run the module to the metadata;</p></li>
<li><p>How we added default values for parameters and inputs explicitly used by the modules (others like <code>.plotInterval</code> were left as <code>NA</code>). The exception was the <code>studyAreaRas</code> input object for which we do not provide a default. However, we added a code check in <code>.inputObject</code> that stops interrupts R if this object is not in <code>sim</code> (see <a href="#protect-yourself-and-others-from-common-mistakesproblems">Protect yourself and others from common mistakes/problems</a>)</p></li>
<li><p>How we use the function <code>prepInputs</code> to do most of the heavy-lifting of downloading data and spatial pre-processing. This function is able to recognize whether the data has already been downloaded, and can cache all spatial processing tasks (see <a href="#caching">Caching</a>). In some cases, we wrapped <code>prepInputs</code> in a <code>Map</code> call to loop through several URLs and download and pre-process many data layers. This <code>Map</code> call can also be cached with <code>Cache</code>.</p></li>
<li><p>How we use the function <code>Plots</code> to control plotting to the screen device and/or save to image files depending on the <code>P(sim)$.plots</code> argument. Note that <code>Plots</code> works best with functions that output <code>ggplot</code> objects, or that are compatible with <code><a href="https://quickplot.predictiveecology.org/reference/Plot.html">quickPlot::Plot</a></code>.</p></li>
<li><p>The fact that neither module depends on the other. This is not a required feature of data modules, but just so happens to be the case in this example. In fact, in more complex modelling frameworks, like the LandR model <span class="citation" data-cites="BarrosEtAlinreview">[@BarrosEtAlinreview]</span>, we often have several data modules that depend on each other (e.g., <a href="https://github.com/PredictiveEcology/Biomass_speciesData">LandR <em>Biomass_speciesData</em></a> sources and processes tree species percent cover data that is used by <a href="https://github.com/PredictiveEcology/Biomass_borealDataPrep">LandR <em>Biomass_borealDataPrep</em></a> to estimate several parameters for the forest landscape simulation model <a href="https://github.com/PredictiveEcology/Biomass_core">LandR <em>Biomass_core</em></a>).</p></li>
<li><p>How we export objects created within the module functions to <code>sim</code>. Without doing so, these objects are lost after the function is executed.</p></li>
</ul></section></section><section id="prediction-module" class="level3" data-number="2.2.2"><h3 data-number="2.2.2" class="anchored" data-anchor-id="prediction-module">
<span class="header-section-number">2.2.2</span> Prediction module</h3>
<p>We show below the <code>.R</code> script for the <em>projectSpeciesDist</em> module. This module depends entirely on the other two, as we did not provide any default input objects in the <code>.inputObjects</code> function. This is, of course, not good practice, but again we warn the user early on (in the <code>.inputObjects</code> function) if the module cannot find the necessary inputs.</p>
<p>This module fits a machine learning SDM using the MaxEnt algorithm implemented in the <code>dismo</code> package. We recommend having a look at <a href="https://rspatial.org/raster/sdm/index.html">this guide</a> to learn about fitting SDMs with <code>dismo</code> and more. Before fitting the SDM, the module converts any non-binary species data into presences and absences.</p>
<p>The main outputs are species distribution projections in the form of plots and a stacked raster layer (<code>sppDistProj</code>) and the fitted SDM object.</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/simulationModule_332e9605a9c26db11c928f6c726c1512">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Everything in this file and any files in the R directory are sourced during `simInit()`;</span></span>
<span><span class="co">## all functions and objects are put into the `simList`.</span></span>
<span><span class="co">## To use objects, use `sim$xxx` (they are globally available to all modules).</span></span>
<span><span class="co">## Functions can be used inside any function that was sourced in this module;</span></span>
<span><span class="co">## they are namespaced to the module, just like functions in R packages.</span></span>
<span><span class="co">## If exact location is required, functions will be: `sim$.mods$&lt;moduleName&gt;$FunctionName`.</span></span>
<span><span class="fu">defineModule</span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"projectSpeciesDist"</span>,</span>
<span>  description <span class="op">=</span> <span class="st">""</span>,</span>
<span>  keywords <span class="op">=</span> <span class="st">""</span>,</span>
<span>  authors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>given <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ceres"</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"Barros"</span>, </span>
<span>                                role <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"aut"</span>, <span class="st">"cre"</span><span class="op">)</span>, email <span class="op">=</span> <span class="st">"ceres.barros@ubc.ca"</span>, comment <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"person"</span><span class="op">)</span>,</span>
<span>  childModules <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>  version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>projectSpeciesDist <span class="op">=</span> <span class="st">"1.0.0"</span><span class="op">)</span>,</span>
<span>  timeframe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXlt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  timeunit <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  citation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"citation.bib"</span><span class="op">)</span>,</span>
<span>  documentation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"README.md"</span>, <span class="st">"projectSpeciesDist.Rmd"</span><span class="op">)</span>, <span class="co">## same file</span></span>
<span>  reqdPkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"SpaDES.core (&gt;=2.0.2)"</span>,</span>
<span>                  <span class="st">"caret"</span>, <span class="st">"data.table"</span>, <span class="st">"dismo"</span>,</span>
<span>                  <span class="st">"ggplot2"</span>, <span class="st">"rJava"</span>, <span class="st">"rasterVis"</span><span class="op">)</span>,</span>
<span>  parameters <span class="op">=</span> <span class="fu">bindrows</span><span class="op">(</span></span>
<span>    <span class="co">#defineParameter("paramName", "paramClass", value, min, max, "parameter description"),</span></span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">"predVars"</span>, <span class="st">"character"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BIO1"</span>, <span class="st">"BIO4"</span>, <span class="st">"BIO12"</span>, <span class="st">"BIO15"</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Predictors used in statistical model."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">"presThresh"</span>, <span class="st">"numeric"</span>, <span class="fl">10</span>, <span class="fl">0</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Minimum threshold for the species to be considered present, when"</span>,</span>
<span>                          <span class="st">" `sppAbundanceDT` contains non binary species data (e.g. %, proportions,"</span>,</span>
<span>                          <span class="st">"or abundance data). By default 10% cover."</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">"statModel"</span>, <span class="st">"character"</span>, <span class="st">"MaxEnt"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"What statitical algorith to use. Currently only 'MaxEnt' and 'GLM' are"</span>,</span>
<span>                          <span class="st">"supported. 'MaxEnt will fit a MaxEnt model using dismo::maxent; 'GLM'"</span>,</span>
<span>                          <span class="st">"will fit a generalised linear model with a logit link using"</span>,</span>
<span>                          <span class="st">"glm(..., family = 'binomial'). In both cases all predictor variables are used,"</span>,</span>
<span>                          <span class="st">"and for GLM only additive effects are considered."</span> <span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".plots"</span>, <span class="st">"character"</span>, <span class="st">"screen"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Used by Plots function, which can be optionally used here"</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".plotInitialTime"</span>, <span class="st">"numeric"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/start.html">start</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Describes the simulation time at which the first plot event should occur."</span><span class="op">)</span>,</span>
<span>    <span class="co">## .seed is optional: `list('init' = 123)` will `set.seed(123)` for the `init` event only.</span></span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".seed"</span>, <span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Named list of seeds to use for each event (names)."</span><span class="op">)</span>,</span>
<span>    <span class="fu">defineParameter</span><span class="op">(</span><span class="st">".useCache"</span>, <span class="st">"logical"</span>, <span class="cn">FALSE</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,</span>
<span>                    <span class="st">"Should caching of events or module be used?"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  inputObjects <span class="op">=</span> <span class="fu">bindrows</span><span class="op">(</span></span>
<span>    <span class="co">#expectsInput("objectName", "objectClass", "input object description", sourceURL, ...),</span></span>
<span>    <span class="fu">expectsInput</span><span class="op">(</span><span class="st">"climateDT"</span>, <span class="st">"data.table"</span>,</span>
<span>                 desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"A data.table with as many columns as the climate covariates"</span>,</span>
<span>                              <span class="st">"used in the species distribution model and 'year' column describing"</span>,</span>
<span>                              <span class="st">"the simulation year to which the data corresponds."</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">expectsInput</span><span class="op">(</span><span class="st">"sppAbundanceDT"</span>, <span class="st">"data.table"</span>,</span>
<span>                 desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"A species abundance data. Converted to presence/absence data, if not binary."</span>,</span>
<span>                              <span class="st">"By default a table with % species cover."</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">expectsInput</span><span class="op">(</span><span class="st">"studyAreaRas"</span>, objectClass <span class="op">=</span> <span class="st">"SpatRaster"</span>,</span>
<span>                 desc <span class="op">=</span> <span class="st">"A binary raster of the study area"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  outputObjects <span class="op">=</span> <span class="fu">bindrows</span><span class="op">(</span></span>
<span>    <span class="co">#createsOutput("objectName", "objectClass", "output object description", ...),</span></span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span>objectName <span class="op">=</span> <span class="st">"sppDistProj"</span>, objectClass <span class="op">=</span> <span class="st">"SpatRaster"</span>,</span>
<span>                  desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Species distribution projections - raw predictions."</span>,</span>
<span>                               <span class="st">"Each layer corresponds to a prediciton year"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span>objectName <span class="op">=</span> <span class="st">"evalOut"</span>, objectClass <span class="op">=</span> <span class="st">"ModelEvaluation"</span>,</span>
<span>                  desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"`sdmOut` model evaluation statistics. Model evaluated on the 20% of"</span>,</span>
<span>                               <span class="st">"the data. See `?dismo::evaluation`."</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span>objectName <span class="op">=</span> <span class="st">"sdmData"</span>, objectClass <span class="op">=</span> <span class="st">"data.table"</span>,</span>
<span>                  desc <span class="op">=</span> <span class="st">"Input data used to fit `sdmOut`."</span><span class="op">)</span>,</span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span>objectName <span class="op">=</span> <span class="st">"sdmOut"</span>, objectClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"MaxEnt"</span>, <span class="st">"glm"</span><span class="op">)</span>,</span>
<span>                  desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Fitted species distribution model. Model fitted on 80%"</span>,</span>
<span>                               <span class="st">"of `sdmData`, with remaining 20% used for evaluation."</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">createsOutput</span><span class="op">(</span>objectName <span class="op">=</span> <span class="st">"thresh"</span>, objectClass <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>                  desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Threshold of presence that maximises the sum of the sensitivity"</span>,</span>
<span>                               <span class="st">"(true positive rate) and specificity (true negative rate)."</span>,</span>
<span>                               <span class="st">"See `dismo::threshold(..., stat = 'spec_sens')`."</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## event types</span></span>
<span><span class="co">#   - type `init` is required for initialization</span></span>
<span></span>
<span><span class="va">doEvent.projectSpeciesDist</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span>, <span class="va">eventTime</span>, <span class="va">eventType</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span></span>
<span>    <span class="va">eventType</span>,</span>
<span>    init <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co">### check for more detailed object dependencies:</span></span>
<span>      <span class="co">### (use `checkObject` or similar)</span></span>
<span>      </span>
<span>      <span class="co"># do stuff for this event</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">SDMInit</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># schedule future event(s)</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">scheduleEvent</span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/stats/start.html">start</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"projectSpeciesDist"</span>, <span class="st">"fitSDM"</span><span class="op">)</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">scheduleEvent</span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/stats/start.html">start</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"projectSpeciesDist"</span>, <span class="st">"evalSDM"</span>,</span>
<span>                           eventPriority <span class="op">=</span> <span class="fu">.normal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">scheduleEvent</span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/stats/start.html">start</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"projectSpeciesDist"</span>, <span class="st">"projSDM"</span>,</span>
<span>                           eventPriority <span class="op">=</span> <span class="fu">.normal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">scheduleEvent</span><span class="op">(</span><span class="va">sim</span>, <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">.plotInitialTime</span>, <span class="st">"projectSpeciesDist"</span>, <span class="st">"plotProjSDM"</span>,</span>
<span>                           eventPriority <span class="op">=</span> <span class="fu">.normal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span>,</span>
<span>    fitSDM <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">fitSDMEvent</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span>      <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>    <span class="op">}</span>,</span>
<span>    evalSDM <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">evalSDMEvent</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span>      <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>    <span class="op">}</span>,</span>
<span>    projSDM <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">projSDMEvent</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">scheduleEvent</span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span>, <span class="st">"projectSpeciesDist"</span>, <span class="st">"projSDM"</span><span class="op">)</span></span>
<span>      <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>    <span class="op">}</span>,</span>
<span>    plotProjSDM <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>      <span class="fu">plotProjEvent</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">scheduleEvent</span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span>, <span class="st">"projectSpeciesDist"</span>, <span class="st">"plotProjSDM"</span>,</span>
<span>                           eventPriority <span class="op">=</span> <span class="fu">.normal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Undefined event type: \'"</span>, <span class="fu">current</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"eventType"</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>                  <span class="st">"\' in module \'"</span>, <span class="fu">current</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"moduleName"</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="st">"\'"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## event functions</span></span>
<span><span class="co">#   - keep event functions short and clean, modularize by calling subroutines from section below.</span></span>
<span></span>
<span><span class="co">### template initialization</span></span>
<span><span class="va">SDMInit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># # ! ----- EDIT BELOW ----- ! #</span></span>
<span>  <span class="co">## at this point we can only have the following columns</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">sppAbundanceDT</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cell"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"sppAbund"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"sim$sppAbundanceDT can only have the following columns at the start of year 1:\n"</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cell"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"sppAbund"</span>, <span class="st">"year"</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">climateDT</span><span class="op">$</span><span class="va">cell</span>, <span class="va">sim</span><span class="op">$</span><span class="va">sppAbundanceDT</span><span class="op">$</span><span class="va">cell</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">||</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">sppAbundanceDT</span><span class="op">$</span><span class="va">cell</span>, <span class="va">sim</span><span class="op">$</span><span class="va">climateDT</span><span class="op">$</span><span class="va">cell</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"'cell' columns in `climateDT` and `sppAbundanceDT` have different values"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">statModel</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"MaxEnt"</span>, <span class="st">"GLM"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"'statModel' parameter must be 'MaxEnt' or 'GLM'"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">## a few data cleaning steps to make sure we have presences and absences:</span></span>
<span>  <span class="va">sppAbundanceDT</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">sppAbundanceDT</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">sppAbundanceDT</span><span class="op">$</span><span class="va">sppAbund</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sppAbundanceDT</span><span class="op">[</span><span class="va">sppAbund</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="va">sppAbund</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sppAbundanceDT</span><span class="op">$</span><span class="va">sppAbund</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Species data is not binary."</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Converting values &gt;= P(sim)$presThresh to presences, and &lt; P(sim)$presThresh to absences"</span><span class="op">)</span></span>
<span>    <span class="va">sppAbundanceDT</span><span class="op">[</span><span class="va">sppAbund</span> <span class="op">&gt;=</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">presThresh</span>, <span class="va">presAbs</span> <span class="op">:=</span> <span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">sppAbundanceDT</span><span class="op">[</span><span class="va">sppAbund</span> <span class="op">&lt;</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">presThresh</span>, <span class="va">presAbs</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">## join the two datasets - note that there are no input species abundances beyond year 1</span></span>
<span>  <span class="va">sim</span><span class="op">$</span><span class="va">sdmData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">climateDT</span>, <span class="va">sppAbundanceDT</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">cell</span>, <span class="va">sppAbund</span>, <span class="va">presAbs</span>, <span class="va">year</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                       by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cell"</span>, <span class="st">"year"</span><span class="op">)</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">fitSDMEvent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>  <span class="co">## break data into training and testing subsets</span></span>
<span>  <span class="va">dataForFitting</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="va">sdmData</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dataForFitting</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"No data for year"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"provided to fit the model"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">group</span> <span class="op">&lt;-</span> <span class="fu">createDataPartition</span><span class="op">(</span><span class="va">dataForFitting</span><span class="op">$</span><span class="va">presAbs</span>, p <span class="op">=</span> <span class="fl">0.8</span>, list <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="co">## save the the split datasets as internal objects to this module</span></span>
<span>  <span class="va">mod</span><span class="op">$</span><span class="va">trainData</span> <span class="op">&lt;-</span> <span class="va">dataForFitting</span><span class="op">[</span><span class="va">group</span><span class="op">]</span></span>
<span>  <span class="va">mod</span><span class="op">$</span><span class="va">testData</span> <span class="op">&lt;-</span>  <span class="va">dataForFitting</span><span class="op">[</span><span class="op">-</span><span class="va">group</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">mod</span><span class="op">$</span><span class="va">trainData</span><span class="op">$</span><span class="va">presAbs</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Training dataset contains no absences."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">predVars</span> <span class="op">&lt;-</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">predVars</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">statModel</span> <span class="op">==</span> <span class="st">"MaxEnt"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sim</span><span class="op">$</span><span class="va">sdmOut</span> <span class="op">&lt;-</span> <span class="fu">maxent</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">mod</span><span class="op">$</span><span class="va">trainData</span><span class="op">[</span>, <span class="va">..predVars</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                         p <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">trainData</span><span class="op">$</span><span class="va">presAbs</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co">## make an additive model with all predictors - avoid using as.formula, which drags the whole environment</span></span>
<span>    <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">enquote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"presAbs ~"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">predVars</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">sim</span><span class="op">$</span><span class="va">sdmOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span>expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">form</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      family <span class="op">=</span> <span class="st">"binomial"</span>, data <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">trainData</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">evalSDMEvent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>  <span class="co">## validate model</span></span>
<span>  <span class="va">predVars</span> <span class="op">&lt;-</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">predVars</span></span>
<span>  <span class="va">sim</span><span class="op">$</span><span class="va">evalOut</span> <span class="op">&lt;-</span> <span class="fu">evaluate</span><span class="op">(</span>p <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">testData</span><span class="op">[</span><span class="va">presAbs</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">..predVars</span><span class="op">]</span>,</span>
<span>                          a <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">testData</span><span class="op">[</span><span class="va">presAbs</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">..predVars</span><span class="op">]</span>,</span>
<span>                          model <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">sdmOut</span><span class="op">)</span></span>
<span>  <span class="co">## save the threshold of presence/absence in an internal object to this module</span></span>
<span>  <span class="va">sim</span><span class="op">$</span><span class="va">thresh</span> <span class="op">&lt;-</span> <span class="fu">threshold</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">evalOut</span>, <span class="st">'spec_sens'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">projSDMEvent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>  <span class="co">## predict across the full data and make a map</span></span>
<span>  <span class="va">dataForPredicting</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="va">sdmData</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dataForPredicting</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"No data for year"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"provided to calculate predictions"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">predVars</span> <span class="op">&lt;-</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">predVars</span></span>
<span>  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">sdmOut</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">dataForPredicting</span><span class="op">[</span>, <span class="va">..predVars</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                   progress <span class="op">=</span> <span class="st">''</span><span class="op">)</span></span>
<span>  <span class="va">sppDistProj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">studyAreaRas</span><span class="op">[</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="va">preds</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sppDistProj</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">sppDistProj</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sim</span><span class="op">$</span><span class="va">sppDistProj</span> <span class="op">&lt;-</span> <span class="va">sppDistProj</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">sim</span><span class="op">$</span><span class="va">sppDistProj</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">sppDistProj</span>, <span class="va">sppDistProj</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plotProjEvent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>  <span class="fu">checkPath</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu">outputPath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"figures"</span><span class="op">)</span>, create <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">.plots</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co">## response plot</span></span>
<span>    <span class="co">## we can't use Plots to plot and save SDM predictions with dismo.</span></span>
<span>    <span class="co">## these are only saved to disk</span></span>
<span>    <span class="va">fileSuffix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">statModel</span>, <span class="st">".png"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">notScreen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">.plots</span>, <span class="st">"screen"</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">notScreen</span> <span class="op">!=</span> <span class="st">"png"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu">currentModule</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"only saves to PNG at the moment."</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu">outputPath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"figures"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"SDMresponsePlot_"</span>, <span class="va">fileSuffix</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">response</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">sdmOut</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## species projections</span></span>
<span>    <span class="va">fileSuffix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">statModel</span>, <span class="st">"_Year"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">clearPlot</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">rawValsPlot</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="va">sppDistProj</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="fu">Plots</span><span class="op">(</span><span class="va">rawValsPlot</span>, fn <span class="op">=</span> <span class="va">plotSpatRaster</span>, types <span class="op">=</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">.plots</span>,</span>
<span>          usePlot <span class="op">=</span> <span class="cn">TRUE</span>, filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu">outputPath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"figures"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"projRawVals_"</span>, <span class="va">fileSuffix</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          plotTitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Projected raw values -"</span>, <span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          xlab <span class="op">=</span> <span class="st">"Longitude"</span>, ylab <span class="op">=</span> <span class="st">"Latitude"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">PAsPlot</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/is.bool.html">as.int</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">sppDistProj</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">sim</span><span class="op">$</span><span class="va">thresh</span><span class="op">)</span></span>
<span>    <span class="fu">Plots</span><span class="op">(</span><span class="va">PAsPlot</span>, fn <span class="op">=</span> <span class="va">plotSpatRaster</span>, types <span class="op">=</span> <span class="fu">P</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">$</span><span class="va">.plots</span>,</span>
<span>          usePlot <span class="op">=</span> <span class="cn">TRUE</span>, filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu">outputPath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">"figures"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"projPA_"</span>, <span class="va">fileSuffix</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          plotTitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Projected presence/absence -"</span>, <span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          xlab <span class="op">=</span> <span class="st">"Longitude"</span>, ylab <span class="op">=</span> <span class="st">"Latitude"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">.inputObjects</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#cacheTags &lt;- c(currentModule(sim), "function:.inputObjects") ## uncomment this if Cache is being used</span></span>
<span>  <span class="va">dPath</span> <span class="op">&lt;-</span> <span class="fu">asPath</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"reproducible.destinationPath"</span>, <span class="fu">dataPath</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu">currentModule</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>, <span class="st">": using dataPath '"</span>, <span class="va">dPath</span>, <span class="st">"'."</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ! ----- EDIT BELOW ----- ! #</span></span>
<span>  <span class="co">## check that necessary objects are in the simList or WILL BE supplied  by another module</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">suppliedElsewhere</span><span class="op">(</span><span class="st">"climateDT"</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="fu">suppliedElsewhere</span><span class="op">(</span><span class="st">"sppAbundanceDT"</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Please provide `climateDT` and `sppAbundanceDT`"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># ! ----- STOP EDITING ----- ! #</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We draw your attention to:</p>
<ul>
<li><p>As we said earlier, we could have added yearly projected values to the <code>sppAbundanceDT</code> table. In this case we probably would have changed this object’s name, since MaxEnt is not modelling species abundance, but probability of occurrence. We suggest this as an exercise to do on your own</p></li>
<li><p>How links with the data modules are established by declaring data modules’ output objects as expected inputs for this module.</p></li>
<li><p>How the <code>fitSDM</code> event does not schedule itself (the SDM only needs to be fitted once).</p></li>
<li><p>How, unlike <code>fitSDM</code>, the <code>projSDM</code> event schedules itself so that model projections are executed for each year of the simulation, provided that there is corresponding environmental data – notice how the functions <code>fitSDMEvent</code> and <code>projSDMEvent</code> both check that there is data for the current year of the simulation (<code>time(sim)</code>).</p></li>
<li><p>How the fitted model object (<code>sdmOut</code>) and it’s evaluation (<code>evalOut</code>) are both module outputs. This way these objects can not only be used by other events, but also inspected by the user after the simulation is finished (see <a href="#transparent-models">Transparent models</a>).</p></li>
</ul>
<p>You will notice that this module performs model fitting (i.e., calibration), predictions and model validation. These three components could be broken into three separate modules. As an exercise, we recommend trying to do so on your own.</p>
</section><section id="additional-module-scripts-and-functions" class="level3" data-number="2.2.3"><h3 data-number="2.2.3" class="anchored" data-anchor-id="additional-module-scripts-and-functions">
<span class="header-section-number">2.2.3</span> Additional module scripts and functions</h3>
<p>All functions needed by a module can be coded within the module script. Often they will be located after all the event functions and before the <code>.inputObjects</code> function; however, their exact location is up to the developer.</p>
<p>For long, complex modules involving many (potentially long) functions, including all functions within a module’s script quickly makes the script long and hard to maintain. Instead, we recommend that additional (i.e., non-event functions) are put into separate scripts and in the module’s <code>R/</code> folder. <code>SpaDES</code> will source any scripts contained in this older and associate its objects/functions with the respective module.</p>
<p><em>Note that, these functions/objects will only be available to the module where the <code>R/</code> is located.</em></p>
<p>Hence, if one or more functions are meant to be shared across modules they will need to either:</p>
<ul>
<li><p>be defined in <code>.GlobalEnv</code> (the global environment – see <code><a href="https://rdrr.io/r/base/environment.html">?.GlobalEnv</a></code>) before running <code>simInit</code>;</p></li>
<li><p>be put it in an <code>R</code> package that is included in the modules’ metadata and installed as other packages – hence the package is in an online repository like GitHub or CRAN;</p></li>
<li><p>be put it in a <em>local</em> <code>R</code> package that is included in the modules’ metadata and installed (e.g., <code><a href="https://remotes.r-lib.org/reference/install_local.html">devtools::install_local</a></code>) or loaded (e.g.&nbsp;<code>devtools::load_all("&lt;pathToPackage&gt;")</code>) “separately” by the user before, as <code>Require</code> is not able to install local packages.</p></li>
</ul>
<p>In this example, we put the plotting functions called by <code>Plots</code> into separate scripts for each module where they are used. Modules <code>speciesAbundanceData</code> and <code>projectSpeciesDist</code> both have the function <code>plotSpatRaster</code> in a <code>plotSpatRaster.R</code> script saved in their respective <code>R/</code> folders:</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/plotSpatRaster_d0e9989a54600b2961d91d28c6a127c1">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#' Function used to plot SpatRaster</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' To be used with Plots</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @param ras a SpatRaster layer</span></span>
<span><span class="co">#' @param title character. Plot title</span></span>
<span><span class="co">#' @param xlab character. X-axis title</span></span>
<span><span class="co">#' @param ylab character. Y-axis title</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @importFrom rasterVis gplot </span></span>
<span><span class="co">#' @importFrom ggplot2 geom_tile scale_fill_brewer coord_equal theme_bw</span></span>
<span></span>
<span><span class="va">plotSpatRaster</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ras</span>, <span class="va">plotTitle</span> <span class="op">=</span> <span class="st">""</span>, <span class="va">xlab</span> <span class="op">=</span> <span class="st">"x"</span>, <span class="va">ylab</span> <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">gplot</span><span class="op">(</span><span class="va">ras</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_tile</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>,</span>
<span>        direction <span class="op">=</span> <span class="fl">1</span>, na.value <span class="op">=</span> <span class="st">"grey90"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="va">plotTitle</span>,</span>
<span>        x <span class="op">=</span> <span class="va">xlab</span>, y <span class="op">=</span> <span class="va">ylab</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>climateData</code> module uses the function <code>plotSparRasterStk</code>, which is in the <code>plotSparRasterStk.R</code> in its <code>R/</code> folder:</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/plotSpatRasterStk_ce8b6be4603187c6e7d17a5c5aa4553d">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#' Function used to plot SpatRaster Stacks</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' To be used with Plots</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @param stk a SpatRaster stack.</span></span>
<span><span class="co">#' @param title character. Plot title</span></span>
<span><span class="co">#' @param xlab character. X-axis title</span></span>
<span><span class="co">#' @param ylab character. Y-axis title</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @importFrom rasterVis gplot</span></span>
<span><span class="co">#' @importFrom ggplot geom_tile facet_wrap scale_fill_brewer coord_equal</span></span>
<span></span>
<span><span class="va">plotSpatRasterStk</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">stk</span>, <span class="va">plotTitle</span> <span class="op">=</span> <span class="st">""</span>, <span class="va">xlab</span> <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    <span class="va">ylab</span> <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">gplot</span><span class="op">(</span><span class="va">stk</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_tile</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>,</span>
<span>        direction <span class="op">=</span> <span class="fl">1</span>, na.value <span class="op">=</span> <span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">variable</span><span class="op">)</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="va">plotTitle</span>,</span>
<span>        x <span class="op">=</span> <span class="va">xlab</span>, y <span class="op">=</span> <span class="va">ylab</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Go ahead and create these scripts with the functions above and put them in the right <code>R/</code> folders.</p>
<hr></section></section><section id="running-the-model" class="level2" data-number="2.3"><h2 data-number="2.3" class="anchored" data-anchor-id="running-the-model">
<span class="header-section-number">2.3</span> Running the model</h2>
<section id="ensuring-all-packages-are-installed" class="level3" data-number="2.3.1"><h3 data-number="2.3.1" class="anchored" data-anchor-id="ensuring-all-packages-are-installed">
<span class="header-section-number">2.3.1</span> Ensuring all packages are installed</h3>
<p>After the modules are created, we go back to the <code>Part2_SDMs.R</code> script to set up and run the simulation. We first ensure that all module dependencies (and their dependencies and so on) are installed in <code><a href="https://rdrr.io/r/base/libPaths.html">.libPaths()</a></code>.</p>
<p>Only then do we load packages necessary to run the simulation.</p>
<p>Note that the <code>dismo</code> package (a dependency of the <code>projectSpeciesDist</code> module) needs <code>rJava</code> to run <code>maxent</code>. In turn, <code>rJava</code> needs a working Java installation (Java can be downloaded <a href="See https://www.java.com/en/download/manual.jsp">here</a>). Below you will see that we attempt to warn the user about problems loading <code>rJava</code>, which are likely related to Java not being found on the system.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">outs</span> <span class="op">&lt;-</span> <span class="fu">SpaDES.project</span><span class="fu">::</span><span class="fu"><a href="http://spades-project.predictiveecology.org/reference/metadata.html">packagesInModules</a></span><span class="op">(</span>modulePath <span class="op">=</span> <span class="va">simPaths</span><span class="op">$</span><span class="va">modulePath</span><span class="op">)</span>  <span class="co">## gets list of module dependencies</span></span>
<span><span class="fu">Require</span><span class="fu">::</span><span class="fu"><a href="https://Require.predictiveecology.org/reference/Require.html">Require</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">outs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   <span class="st">"DiagrammeR"</span><span class="op">)</span>, </span>
<span>                 require <span class="op">=</span> <span class="cn">FALSE</span>,   <span class="co">## don't load packages</span></span>
<span>                 upgrade <span class="op">=</span> <span class="cn">FALSE</span>,   <span class="co">## don't upgrade dependencies</span></span>
<span>                 standAlone <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">## install all dependencies in proj-lib (ignore user/system lib)</span></span>
<span>                 purge <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## now load packages - SpaDES.core may have been loaded already, which is fine</span></span>
<span><span class="fu">Require</span><span class="fu">::</span><span class="fu"><a href="https://Require.predictiveecology.org/reference/Require.html">Require</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reproducible"</span>, <span class="st">"SpaDES.core"</span>, <span class="st">"SpaDES.experiment"</span><span class="op">)</span>, </span>
<span>                 install <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## dismo needs a few tweaks to run MaxEnt</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">reproducible</span><span class="fu">::</span><span class="fu"><a href="https://reproducible.predictiveecology.org/reference/preProcess.html">preProcess</a></span><span class="op">(</span>targetFile <span class="op">=</span> <span class="st">"maxent.jar"</span>,</span>
<span>                                url <span class="op">=</span> <span class="st">"https://github.com/mrmaxent/Maxent/blob/master/ArchivedReleases/3.4.4/maxent.jar?raw=true"</span>,</span>
<span>                                destinationPath <span class="op">=</span> <span class="va">simPaths</span><span class="op">$</span><span class="va">inputPath</span>,</span>
<span>                                fun <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">targetFilePath</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"java"</span>, package<span class="op">=</span><span class="st">"dismo"</span><span class="op">)</span>, <span class="st">"maxent.jar"</span><span class="op">)</span>,</span>
<span>          overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://www.rforge.net/rJava/">rJava</a></span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">out</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Your Java installation may have problems, please check.\n"</span>, </span>
<span>             <span class="st">"See https://www.java.com/en/download/manual.jsp for Java installation"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>/!\ ATTENTION /!\</strong></p>
<p><em>Windows can present problems when many packages are installed and further package installations fail. If you see errors like this after restarting R:</em></p>
<pre><code>Installing: glue Detaching is fraught with many potential problems; you may 
have to restart your session if things aren't working some packages don't seem
to unload their dlls correctly.
These will not be unloaded: ellipsis, vctrs Unloading package bit64 -- 
Installing glue -- (1 of 1. Estimated time left: ...; est. finish: ...calculating) 
Installing package into '\~/R/win-library/4.0' (as 'lib' is unspecified) trying URL
'&lt;https://cran.rstudio.com/bin/windows/contrib/4.0/glue_1.6.2.zip&gt;' Content type
'application/zip' length 171858 bytes (167 KB) downloaded 167 KB

package 'glue' successfully unpacked and MD5 sums checked 
Error in unpackPkgZip(foundpkgs[okp, 2L], foundpkgs[okp, 1L], lib, libs_only, : 
ERROR: failed to lock directory '\~\R\win-library\\4.0' for modifying 
Try removing '\~\R\win-library\\4.0/00LOCK'</code></pre>
<p><em>If you encounter this error, delete the problematic file/folder and try again.</em></p>
<p><em>Sometimes <code>Require</code> may still unable to automatically install a package and a manual installation from a clean session is the only solution. In the error above, <code>Require</code> only detected that <code>glue</code> was missing during the <code>simInit</code> call, which meant that other packages had been loaded already causing failure when <code>Require</code> attempted the installation. This problem persisted even after we avoided loading <code>terra</code> before running <code>simInit</code> (we make the study area objects prefixing functions with <code>terra::</code>), so <code>glue</code> had to be manually installed.</em></p>
</section><section id="simulation-set-up" class="level3" data-number="2.3.2"><h3 data-number="2.3.2" class="anchored" data-anchor-id="simulation-set-up">
<span class="header-section-number">2.3.2</span> Simulation set-up</h3>
<p>The simulation folder directories were already set up before creating the modules (see above), but it is still necessary to create a few lists that will be passed to the <code>simInit</code> function, which initializes the simulation. These lists define the modules used in the simulation (<code>simModules</code>), the start and end of the simulation (<code>simTimes</code>), the parameters passed to each module (<code>simParams</code>) and external input objects (<code>simObjects</code>) like the study area (<code>studyAreaRas</code>).</p>
<p>The <code>studyAreaRas</code> is created from a random polygon drawn in SW Alberta, Canada, using <code><a href="https://spades-tools.predictiveecology.org/reference/randomStudyArea.html">SpaDES.tools::randomStudyArea</a></code>. (<a href="#fig-studyAreaCanada" class="quarto-xref">Figure&nbsp;<span>2.1</span></a>).</p>
<p>We also define a few useful global options:</p>
<ul>
<li><p><code>reproducible.cachePath</code> and <code>reproducible.destinationPath</code> define the cache directory and the directory where downloaded and processed data will be stored;</p></li>
<li><p><code>reproducible.useCache</code> and <code>reproducible.useTerra</code>, which will activate caching and the use of the <code>terra</code> package across all <code>Cache</code> and <code>prepInputs</code> function calls.</p></li>
</ul>
<div class="cell" data-hash="Part2_SDMs_cache/html/simulationSetup_35fc3d50edc991945b23fa5887af14ae">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## a few important options:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>reproducible.useCache <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        reproducible.cachePath <span class="op">=</span> <span class="va">simPaths</span><span class="op">$</span><span class="va">cachePath</span>,</span>
<span>        reproducible.destinationPath <span class="op">=</span> <span class="va">simPaths</span><span class="op">$</span><span class="va">inputPath</span>, <span class="co">## all downloaded and pre-processed layers go here</span></span>
<span>        reproducible.useTerra <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">## we want to use the terra R package</span></span>
<span>        spades.moduleCodeChecks <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        spades.useRequire <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co">## list the modules to use</span></span>
<span><span class="va">simModules</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"speciesAbundanceData"</span>, <span class="st">"climateData"</span>, <span class="st">"projectSpeciesDist"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Set simulation and module parameters</span></span>
<span><span class="va">simTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">5</span>, timeunit <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## we create two lists of parameters, one using the default MaxEnt</span></span>
<span><span class="co">## the other a GLM</span></span>
<span><span class="va">simParamsMaxEnt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"speciesAbundanceData"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">".plots"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"png"</span><span class="op">)</span>,</span>
<span>    <span class="st">".useCache"</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"climateData"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">".plots"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"png"</span><span class="op">)</span>,</span>
<span>    <span class="st">".useCache"</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"projectSpeciesDist"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"statModel"</span> <span class="op">=</span> <span class="st">"MaxEnt"</span>,</span>
<span>    <span class="st">".plots"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"png"</span><span class="op">)</span>,</span>
<span>    <span class="st">".useCache"</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simParamsGLM</span> <span class="op">&lt;-</span> <span class="va">simParamsMaxEnt</span></span>
<span><span class="va">simParamsGLM</span><span class="op">$</span><span class="va">projectSpeciesDist</span><span class="op">$</span><span class="va">statModel</span> <span class="op">&lt;-</span> <span class="st">"GLM"</span></span>
<span></span>
<span><span class="co">## make a random study area.</span></span>
<span><span class="co">##  Here use seed to make sure the same study area is always generated</span></span>
<span><span class="va">studyArea</span> <span class="op">&lt;-</span> <span class="fu">SpaDES.tools</span><span class="fu">::</span><span class="fu"><a href="https://spades-tools.predictiveecology.org/reference/randomStudyArea.html">randomStudyArea</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1e10</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">studyAreaRas</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rasterize.html">rasterize</a></span><span class="op">(</span><span class="va">studyArea</span>, </span>
<span>                                 <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span>extent <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html">ext</a></span><span class="op">(</span><span class="va">studyArea</span><span class="op">)</span>, </span>
<span>                                             crs <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crs.html">crs</a></span><span class="op">(</span><span class="va">studyArea</span>, proj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                                             resolution <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simObjects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"studyAreaRas"</span> <span class="op">=</span> <span class="va">studyAreaRas</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Simulation setup - create two simulations, one for MaxEnt another for GLM</span></span>
<span><span class="co">## SpaDES.experiment::experiment2, will take care of subdirectories to store outputs</span></span>
<span><span class="va">mySimMaxEnt</span> <span class="op">&lt;-</span> <span class="fu">simInit</span><span class="op">(</span>times <span class="op">=</span> <span class="va">simTimes</span>, params <span class="op">=</span> <span class="va">simParamsMaxEnt</span>, </span>
<span>                       modules <span class="op">=</span> <span class="va">simModules</span>, objects <span class="op">=</span> <span class="va">simObjects</span>, </span>
<span>                       paths <span class="op">=</span> <span class="va">simPaths</span><span class="op">)</span></span>
<span><span class="va">mySimGLM</span> <span class="op">&lt;-</span> <span class="fu">simInit</span><span class="op">(</span>times <span class="op">=</span> <span class="va">simTimes</span>, params <span class="op">=</span> <span class="va">simParamsGLM</span>, </span>
<span>                    modules <span class="op">=</span> <span class="va">simModules</span>, objects <span class="op">=</span> <span class="va">simObjects</span>, </span>
<span>                    paths <span class="op">=</span> <span class="va">simPaths</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center" data-hash="Part2_SDMs_cache/html/fig-studyAreaCanada_217058e0bcea328abb00939645b33d90">
<div class="cell-output-display">
<div id="fig-studyAreaCanada" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-studyAreaCanada-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Part2_SDMs_files/figure-html/fig-studyAreaCanada-1.png" class="img-fluid quarto-figure-center figure-img" width="672">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-studyAreaCanada-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.1: Study area within Canada.
</figcaption></figure>
</div>
</div>
</div>
<p>Before running the simulation we look at the module linkage diagrams produced by <code>moduleDiagram</code> (<a href="#fig-moduleDiagram2" class="quarto-xref">Figure&nbsp;<span>2.2</span></a>)) and <code>objectDiagram</code> (<a href="#fig-objectDiagram2" class="quarto-xref">Figure&nbsp;<span>2.3</span></a>) to assess whether modules are linked as expected.</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/moduleDiagramsCode_43e8d1c4ff43bac7d4f3d440b263768c">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">moduleDiagram</span><span class="op">(</span><span class="va">mySimMaxEnt</span><span class="op">)</span></span>
<span><span class="fu">objectDiagram</span><span class="op">(</span><span class="va">mySimMaxEnt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center" data-hash="Part2_SDMs_cache/html/fig-moduleDiagram2_9b2b8d19eeaa53e51efb3b5ea4f4ae60">
<div class="cell-output-display">
<div id="fig-moduleDiagram2" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="576">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-moduleDiagram2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Part2_SDMs_files/figure-html/fig-moduleDiagram2-1.png" class="img-fluid quarto-figure-center figure-img" width="576">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-moduleDiagram2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.2: Module network diagram.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="Part2_SDMs_cache/html/fig-objectDiagram2_4338314c2a7dfb38c8857e8718646fed">
<div class="cell-output-display">
<div id="fig-objectDiagram2" class="quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-objectDiagram2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/figures/Part2_objectDiagram.png" class="img-fluid quarto-figure-center figure-img">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-objectDiagram2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.3: Module diagram showing module inter-dependencies with object names.
</figcaption></figure>
</div>
</div>
</div>
</section><section id="simulation-runs" class="level3" data-number="2.3.3"><h3 data-number="2.3.3" class="anchored" data-anchor-id="simulation-runs">
<span class="header-section-number">2.3.3</span> Simulation runs</h3>
<p>To run the simulation, we can call <code>spades</code> on the output <code>simList</code>s (called <code>mySimMaxEnt</code> and <code>mySimMaxGLM</code> here) generated by <code>simInit</code>, or use <code>experiment2</code> from the <code>SpaDES.experiment</code> package. <code>experiment2</code> will run as many simulations as <code>simList</code>s and organise outputs into sub-folders within the <code>simPaths$outputs</code> directory. It can also repeat simulations (<code>rep</code> argument) and parallelise across replicates using <code>future</code>. See <code>?experiment2</code> for examples.</p>
<p>We advise using <code>spades</code> when running the model for the first time. Passing the argument <code>debug = TRUE</code> will print the progress of the simulation in detail. This helps diagnosing problems when the simulation fails, but also seeing which events are being executed and when particular cache calls are activated.</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/runSimulation_b1292d7b84b31b05e1e507566fcd637c">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## run simulation</span></span>
<span><span class="fu">clearPlot</span><span class="op">(</span>force <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co">## this forces wiping the graphics device and opening a new window</span></span>
<span></span>
<span><span class="co">## This runs one simulation and stores outputs in the main</span></span>
<span><span class="co">## 'outputs' folder - not what we want, but good for</span></span>
<span><span class="co">## testing mySimOut &lt;- spades(mySimMaxEnt, debug = TRUE)</span></span>
<span></span>
<span><span class="co">## Better to use when spades runs error-free on the</span></span>
<span><span class="co">## simLists</span></span>
<span><span class="va">myExperiment</span> <span class="op">&lt;-</span> <span class="fu">experiment2</span><span class="op">(</span>MaxEnt <span class="op">=</span> <span class="va">mySimMaxEnt</span>, GLM <span class="op">=</span> <span class="va">mySimGLM</span>,</span>
<span>    debug <span class="op">=</span> <span class="cn">TRUE</span>, replicates <span class="op">=</span> <span class="fl">1</span>, clearSimEnv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co">## prevent removing objects from the simLists at the end</span></span>
<span><span class="co">## save outputs</span></span>
<span><span class="fu">qs</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html">qsave</a></span><span class="op">(</span><span class="va">myExperiment</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">simPaths</span><span class="op">$</span><span class="va">outputPath</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"myExperiment"</span>,</span>
<span>    <span class="st">".qs"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Try to execute the <code>spades</code> call twice to see how much faster it runs after many of the operations have been cached (see also <a href="#caching">Caching</a>).</p>
<p>By default the data modules (<em>speciesAbundanceData</em> and <em>climateData</em>) save figures of the input species and climate layers (<a href="#fig-simulationSppAbund" class="quarto-xref">Figure&nbsp;<span>2.4</span></a> and <a href="#fig-simulationClimate" class="quarto-xref">Figure&nbsp;<span>2.5</span></a> , respectively).</p>
<div class="cell" data-layout-align="center" data-hash="Part2_SDMs_cache/html/fig-simulationSppAbund_8bb48ffd4d9a641f3b5cffb276b54746">
<div class="cell-output-display">
<div id="fig-simulationSppAbund" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="50%">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-simulationSppAbund-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/GLM_rep1/figures/speciesAbundance.png" class="img-fluid quarto-figure-center figure-img" style="width:50.0%">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-simulationSppAbund-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.4: Prediction plots. Input <em>Picea glauca</em> percent cover across the landscape. Note that values are converted to presence/absence.
</figcaption></figure>
</div>
</div>
</div>
<div id="fig-simulationClimate" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-simulationClimate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationClimate" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationClimate-1" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationClimate-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/GLM_rep1/figures/climateRas_BIO1.png" id="fig-simulationClimate-1" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationClimate">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationClimate-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationClimate" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationClimate-2" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationClimate-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/GLM_rep1/figures/climateRas_BIO12.png" id="fig-simulationClimate-2" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationClimate">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationClimate-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationClimate" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationClimate-3" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationClimate-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/GLM_rep1/figures/climateRas_BIO15.png" id="fig-simulationClimate-3" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationClimate">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationClimate-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationClimate" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationClimate-4" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationClimate-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/GLM_rep1/figures/climateRas_BIO4.png" id="fig-simulationClimate-4" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationClimate">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationClimate-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-simulationClimate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.5: Prediction plots. Bioclimatic variables under baseline (year 1) and future conditions.
</figcaption></figure>
</div>
<p>The prediction module also outputs the projections for each climate period automatically ( <a href="#fig-simulationProj" class="quarto-xref">Figure&nbsp;<span>2.6</span></a> and <a href="#fig-simulationProj2" class="quarto-xref">Figure&nbsp;<span>2.7</span></a> ).</p>
<div id="fig-simulationProj" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-simulationProj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj-1" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projRawVals_MaxEnt_Year1.png" id="fig-simulationProj-1" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj-2" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projRawVals_MaxEnt_Year2.png" id="fig-simulationProj-2" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj-3" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projRawVals_MaxEnt_Year3.png" id="fig-simulationProj-3" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj-4" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projRawVals_MaxEnt_Year4.png" id="fig-simulationProj-4" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj-5" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projRawVals_MaxEnt_Year5.png" id="fig-simulationProj-5" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(e)
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-simulationProj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.6: Prediction plots: Raw predicted values of species probability of occurence under (left to right) baseline climate conditions (first year of simulation), 2021-2040, 2041-2060, 2061-2080 and 2081-2100 climate conditions (second to fifth years of simulation) - using MaxEnt.
</figcaption></figure>
</div>
<div id="fig-simulationProj2" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-simulationProj2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj2" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj2-1" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj2-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projPA_MaxEnt_Year1.png" id="fig-simulationProj2-1" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj2">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj2-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj2" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj2-2" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj2-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projPA_MaxEnt_Year2.png" id="fig-simulationProj2-2" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj2">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj2-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj2" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj2-3" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj2-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projPA_MaxEnt_Year3.png" id="fig-simulationProj2-3" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj2">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj2-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj2" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj2-4" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj2-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projPA_MaxEnt_Year4.png" id="fig-simulationProj2-4" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj2">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj2-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simulationProj2" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-simulationProj2-5" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-simulationProj2-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/MaxEnt_rep1/figures/projPA_MaxEnt_Year5.png" id="fig-simulationProj2-5" class="img-fluid quarto-figure-center figure-img" style="width:80.0%" data-ref-parent="fig-simulationProj2">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-simulationProj2-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(e)
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-simulationProj2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.7: Prediction plots: Predictions of <em>Picea glauca</em> presence/absence under (left to right) baseline climate conditions (first year of simulation), 2021-2040, 2041-2060, 2061-2080 and 2081-2100 climate conditions (second to fifth years of simulation) - using MaxEnt.
</figcaption></figure>
</div>
<p>The projected layers can also be accessed and plotted via the <code>simList</code> object, as can the model validation results.</p>
<p>From the results we can see that the MaxEnt and GLM predictions do not seem to agree, indicating a potential problem. We may be missing important covariates, interactions, or simply more appropriate algorithms.</p>
<p>Peruse each model’s estimated coefficients and residuals, and validation results will be a good first step to diagnosing the problem.</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/evalOutSim_cdd6b55f0901acd9b0f44021896ee237">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">myExperiment</span><span class="op">$</span><span class="va">MaxEnt_rep1</span><span class="op">$</span><span class="va">sdmOut</span>  <span class="co">## this links to an html page</span></span>
<span></span>
<span><span class="va">sets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">myExperiment</span><span class="op">$</span><span class="va">GLM_rep1</span><span class="op">$</span><span class="va">sdmOut</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">sets</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## check validation results for the two models</span></span>
<span><span class="va">myExperiment</span><span class="op">$</span><span class="va">MaxEnt_rep1</span><span class="op">$</span><span class="va">evalOut</span></span>
<span><span class="va">myExperiment</span><span class="op">$</span><span class="va">GLM_rep1</span><span class="op">$</span><span class="va">evalOut</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="adding-a-new-climate-scenario" class="level4" data-number="2.3.3.1"><h4 data-number="2.3.3.1" class="anchored" data-anchor-id="adding-a-new-climate-scenario">
<span class="header-section-number">2.3.3.1</span> Adding a new climate scenario</h4>
<p>Because data were linked to the modules (and the forecasting) via the modules’ metadata and inputs, adding a new climate scenario and re-running forecasts is easy.</p>
<p>To do so, we need only to change the URLs for the climate layers, by passing a custom <code>projClimateURLs</code> <code>data.table</code> to the <em>climateData</em> module. <code>SpaDES</code> will take care of downloading and processing the new layers, as well as forecasting. Model fitting will also be repeated, even if the baseline data did not change, because the <code>kfold</code> function we use to partition the data into the training and testing subsets randomly assigns cases to each group. If this was not desired, we could set a random seed before running the fitting event (<code>fitSDM</code>) by passing the <code>.seed</code> parameter to the <em>projectSpeciesDist</em> module (e.g., <code>.seed = list("fitSDM" = 123)</code>).</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/newScenarios_88f4d8c78cde4211cf5332c9a2e1ba8a">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Run with another climate scenario - the most contrasting</span></span>
<span><span class="co">## scenario to SSP 585 get the original table from one of</span></span>
<span><span class="co">## the simulations and replace the climate scenario</span></span>
<span><span class="va">projClimateURLs</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">mySimMaxEnt</span><span class="op">$</span><span class="va">projClimateURLs</span><span class="op">)</span></span>
<span><span class="va">projClimateURLs</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span>URL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"ssp585"</span>, <span class="st">"ssp126"</span>, <span class="va">URL</span><span class="op">)</span>, targetFile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"ssp585"</span>,</span>
<span>    <span class="st">"ssp126"</span>, <span class="va">targetFile</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## this time we pass the new table or URLs to the modules,</span></span>
<span><span class="co">## so that climate layers are changed</span></span>
<span><span class="va">simObjects2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>studyAreaRas <span class="op">=</span> <span class="va">studyAreaRas</span>, projClimateURLs <span class="op">=</span> <span class="va">projClimateURLs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mySimMaxEnt2</span> <span class="op">&lt;-</span> <span class="fu">simInit</span><span class="op">(</span>times <span class="op">=</span> <span class="va">simTimes</span>, params <span class="op">=</span> <span class="va">simParamsMaxEnt</span>,</span>
<span>    modules <span class="op">=</span> <span class="va">simModules</span>, objects <span class="op">=</span> <span class="va">simObjects2</span>, paths <span class="op">=</span> <span class="va">simPaths</span><span class="op">)</span></span>
<span><span class="va">mySimGLM2</span> <span class="op">&lt;-</span> <span class="fu">simInit</span><span class="op">(</span>times <span class="op">=</span> <span class="va">simTimes</span>, params <span class="op">=</span> <span class="va">simParamsGLM</span>,</span>
<span>    modules <span class="op">=</span> <span class="va">simModules</span>, objects <span class="op">=</span> <span class="va">simObjects2</span>, paths <span class="op">=</span> <span class="va">simPaths</span><span class="op">)</span></span>
<span></span>
<span><span class="va">myExperiment2</span> <span class="op">&lt;-</span> <span class="fu">experiment2</span><span class="op">(</span>MaxEnt <span class="op">=</span> <span class="va">mySimMaxEnt2</span>, GLM <span class="op">=</span> <span class="va">mySimGLM2</span>,</span>
<span>    debug <span class="op">=</span> <span class="cn">TRUE</span>, replicates <span class="op">=</span> <span class="fl">1</span>, clearSimEnv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## save outputs</span></span>
<span><span class="fu">qs</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html">qsave</a></span><span class="op">(</span><span class="va">myExperiment2</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">simPaths</span><span class="op">$</span><span class="va">outputPath</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"myExperiment2"</span>,</span>
<span>    <span class="st">".qs"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="proposed-exercises" class="level4" data-number="2.3.3.2"><h4 data-number="2.3.3.2" class="anchored" data-anchor-id="proposed-exercises">
<span class="header-section-number">2.3.3.2</span> Proposed exercises</h4>
<ol type="1">
<li><p>try changing the climate layers (e.g., use different climate scenarios or General Circulation models) and rerunning predictions;</p></li>
<li><p>try adding other statistical algorithms;</p></li>
<li><p>try breaking up the prediction module into three modules: a calibration module, a prediction module and a validation module.</p></li>
</ol>
<p>Have fun!</p>
</section><section id="making-use-of-simlist-for-reporting" class="level4" data-number="2.3.3.3"><h4 data-number="2.3.3.3" class="anchored" data-anchor-id="making-use-of-simlist-for-reporting">
<span class="header-section-number">2.3.3.3</span> Making use of <code>simList</code> for reporting</h4>
<p>Another advantage of having all simulation parameters, inputs and outputs centralised in one object, is that we can easily inspect and manipulated them afterwards, without the need to load separate objects back into <code>R</code>.</p>
<p>Here we show how we capitalize on this <code>SpaDES</code> feature to create figures of the outputs (<a href="#fig-newScenarios" class="quarto-xref">Figure&nbsp;<span>2.8</span></a>).</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/newScenariosFigCode_7eaf4a0377f055310764e4a1ef575679">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## MaxEnt predictions across time and for each climate</span></span>
<span><span class="co">## scenario -------------- combine plots from two distinct</span></span>
<span><span class="co">## simulations in a single figure (the same can be done to</span></span>
<span><span class="co">## compare MaxEnt and GLM, or plot all projections)</span></span>
<span></span>
<span><span class="co">## fetch the internal plotting function instead of</span></span>
<span><span class="co">## repeating code here</span></span>
<span><span class="va">plotFun</span> <span class="op">&lt;-</span> <span class="va">myExperiment</span><span class="op">$</span><span class="va">GLM_rep1</span><span class="op">@</span><span class="va">.envir</span><span class="op">$</span><span class="va">.mods</span><span class="op">$</span><span class="va">climateData</span><span class="op">$</span><span class="va">plotSpatRasterStk</span></span>
<span></span>
<span><span class="co">## raw predictions exported by the module</span></span>
<span><span class="va">sppDistProjMaxEnt</span> <span class="op">&lt;-</span> <span class="va">myExperiment</span><span class="op">$</span><span class="va">MaxEnt_rep1</span><span class="op">$</span><span class="va">sppDistProj</span></span>
<span><span class="va">sppDistProjMaxEnt2</span> <span class="op">&lt;-</span> <span class="va">myExperiment2</span><span class="op">$</span><span class="va">MaxEnt_rep1</span><span class="op">$</span><span class="va">sppDistProj</span></span>
<span></span>
<span><span class="co">## we convert the raw predictions into presence absence</span></span>
<span><span class="co">## using exported threshold</span></span>
<span><span class="va">sppDistProjMaxEnt_PA</span> <span class="op">&lt;-</span> <span class="fu">as.int</span><span class="op">(</span><span class="va">myExperiment</span><span class="op">$</span><span class="va">MaxEnt_rep1</span><span class="op">$</span><span class="va">sppDistProj</span> <span class="op">&gt;</span></span>
<span>    <span class="va">myExperiment</span><span class="op">$</span><span class="va">MaxEnt_rep1</span><span class="op">$</span><span class="va">thresh</span><span class="op">)</span></span>
<span><span class="va">sppDistProjMaxEnt2_PA</span> <span class="op">&lt;-</span> <span class="fu">as.int</span><span class="op">(</span><span class="va">myExperiment2</span><span class="op">$</span><span class="va">MaxEnt_rep1</span><span class="op">$</span><span class="va">sppDistProj</span> <span class="op">&gt;</span></span>
<span>    <span class="va">myExperiment2</span><span class="op">$</span><span class="va">MaxEnt_rep1</span><span class="op">$</span><span class="va">thresh</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## rename layers from plotting</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sppDistProjMaxEnt</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sppDistProjMaxEnt2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2001"</span>,</span>
<span>    <span class="st">"2021-2040"</span>, <span class="st">"2041-2060"</span>, <span class="st">"2061-2080"</span>, <span class="st">"2081-2100"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sppDistProjMaxEnt_PA</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sppDistProjMaxEnt2_PA</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2001"</span>,</span>
<span>    <span class="st">"2021-2040"</span>, <span class="st">"2041-2060"</span>, <span class="st">"2061-2080"</span>, <span class="st">"2081-2100"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## for a simpler plot choose only years 2001, 2041-2060 and</span></span>
<span><span class="co">## 2081-2100</span></span>
<span><span class="va">yrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2001"</span>, <span class="st">"2041-2060"</span>, <span class="st">"2081-2100"</span><span class="op">)</span></span>
<span><span class="va">plotMaxEnt</span> <span class="op">&lt;-</span> <span class="fu">plotFun</span><span class="op">(</span><span class="va">sppDistProjMaxEnt</span><span class="op">[[</span><span class="va">yrs</span><span class="op">]</span><span class="op">]</span>, xlab <span class="op">=</span> <span class="st">"Longitude"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Latitude"</span>, plotTitle <span class="op">=</span> <span class="st">"MaxEnt raw predictions - SSP 585"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"grey90"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>        begin <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">plotMaxEnt2</span> <span class="op">&lt;-</span> <span class="fu">plotFun</span><span class="op">(</span><span class="va">sppDistProjMaxEnt2</span><span class="op">[[</span><span class="va">yrs</span><span class="op">]</span><span class="op">]</span>, xlab <span class="op">=</span> <span class="st">"Longitude"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Latitude"</span>, plotTitle <span class="op">=</span> <span class="st">"MaxEnt raw predictions - SSP 126"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"grey90"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>        begin <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">plotMaxEnt_PA</span> <span class="op">&lt;-</span> <span class="fu">plotFun</span><span class="op">(</span><span class="va">sppDistProjMaxEnt_PA</span><span class="op">[[</span><span class="va">yrs</span><span class="op">]</span><span class="op">]</span>, xlab <span class="op">=</span> <span class="st">"Longitude"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Latitude"</span>, plotTitle <span class="op">=</span> <span class="st">"MaxEnt presence/absence - SSP 585"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"grey90"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>        begin <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">plotMaxEnt2_PA</span> <span class="op">&lt;-</span> <span class="fu">plotFun</span><span class="op">(</span><span class="va">sppDistProjMaxEnt2_PA</span><span class="op">[[</span><span class="va">yrs</span><span class="op">]</span><span class="op">]</span>, xlab <span class="op">=</span> <span class="st">"Longitude"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Latitude"</span>, plotTitle <span class="op">=</span> <span class="st">"MaxEnt presence/absence - SSP 126"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"grey90"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>        begin <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## organise the plots with mildest scenario first It is</span></span>
<span><span class="co">## clear that MaxEnt and GLM do not agree in their</span></span>
<span><span class="co">## prediction</span></span>
<span><span class="va">plotAll</span> <span class="op">&lt;-</span> <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">ggarrange</a></span><span class="op">(</span><span class="va">plotMaxEnt2</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="st">"Scenario - SSP 126"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu">atop</span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="st">"Raw predictions"</span><span class="op">)</span>, <span class="st">"Latitude"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, legend.key.height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">3</span>,</span>
<span>        <span class="st">"lines"</span><span class="op">)</span>, plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, plot.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">0</span>,</span>
<span>        <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, <span class="va">plotMaxEnt</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="st">"Scenario - SSP 585"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu">atop</span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="st">""</span><span class="op">)</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    plot.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, <span class="va">plotMaxEnt2_PA</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu">atop</span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="st">"Presence/absence"</span><span class="op">)</span>, <span class="st">"Latitude"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, <span class="va">plotMaxEnt_PA</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu">atop</span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="st">""</span><span class="op">)</span>,</span>
<span>        <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, legend <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>    common.legend <span class="op">=</span> <span class="cn">TRUE</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a)"</span>, <span class="st">"b)"</span>, <span class="st">"c)"</span>, <span class="st">"d)"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## save figure:</span></span>
<span><span class="va">figDir</span> <span class="op">&lt;-</span> <span class="fu">checkPath</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">simPaths</span><span class="op">$</span><span class="va">outputPath</span>, <span class="st">"generalFigures"</span><span class="op">)</span>,</span>
<span>    create <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">ggsave</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">figDir</span>, <span class="st">"MaxEntPredictions.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">13.5</span>,</span>
<span>    height <span class="op">=</span> <span class="fl">5.5</span>, units <span class="op">=</span> <span class="st">"in"</span>, dpi <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center" data-hash="Part2_SDMs_cache/html/fig-newScenarios_6109b401c1bed88619e9cec9b21de30e">
<div class="cell-output-display">
<div id="fig-newScenarios" class="quarto-figure quarto-figure-center anchored" data-fig-align="center" width="80%">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-newScenarios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="D:/GitHub/SpaDES4Dummies/outputs/generalFigures/MaxEntPredictions.png" class="img-fluid quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-newScenarios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.8: Adding a new scenario: Predictions of <em>Picea glauca</em> probabilities of presences and presence/absence under (left to right) baseline climate conditions, 2041-2060, and 2081-2100 climate projections under two emission scenarios (SSP 136 and SSP 585, the default) – showing MaxEnt forecasts only.
</figcaption></figure>
</div>
</div>
</div>
<hr></section></section></section><section id="caching" class="level2" data-number="2.4"><h2 data-number="2.4" class="anchored" data-anchor-id="caching">
<span class="header-section-number">2.4</span> Caching</h2>
<p>In this example, we relied on caching to avoid having to repeat computationally intensive operations. Running the <code>simInit</code> and <code>spades</code> calls a second time (even after restarting R session) was faster and <code>SpaDES</code> informed us of instances where cached objects were being retrieved:</p>
<pre><code>(...) 
Mar05 19:56:53 clmtDt 1 climateData init 1\
Mar05 19:56:53 clmtDt ...(Object to retrieve (a7816e2d0deb3b29.rds)) Mar05 19:56:53 clmtDt loaded cached result from previous Map call
(...)</code></pre>
<p>Caching in <code>SpaDES</code> is managed by the <code>reproducible</code> package, and can be generally broken down into two types: explicitly coded by the module developer, or internal to <code>SpaDES</code> functions.</p>
<section id="explicitly-caching-operations" class="level3" data-number="2.4.1"><h3 data-number="2.4.1" class="anchored" data-anchor-id="explicitly-caching-operations">
<span class="header-section-number">2.4.1</span> Explicitly caching operations</h3>
<p>Throughout the data modules we explicitly cached several data preparation operations using the functions <code>Cache</code> and <code>prepInputs</code> from the <code>reproducible</code> package.</p>
<p>In brief, <code>Cache</code> searches for a stored (i.e.&nbsp;cached) output of a given function call; if it does not find it, <code>Cache</code> executes the function call, saves its output and saves information about the function inputs and the function’s code. If it does find it, <code>Cache</code> compares the present inputs and function code against their cached counterparts. In case of a mismatch, the function call is executed again and re-cached.</p>
<p><code>prepInputs</code> calls <code>Cache</code> internally at several points, notably to cache spatial processing tasks (e.g.&nbsp;projecting and cropping spatial layers to a study area raster). Another great feature of <code>prepInputs</code> is that when it has a source URL for the target file (as when we used <code>prepInputs</code> to download species % cover and climate layers), it first checks whether the data have already been downloaded (and potentially extracted from an archive folder – <code>.zip</code> file). This is not the same thing as caching, but also avoids unnecessary downloads that can be time consuming.</p>
<p>Note that caching operations involving stochasticity should be avoided, as it will prevent new random outputs from being generated.</p>
<p>We recommend exploring the examples available in the <code>Cache</code> and <code>prepInputs</code> R documentation to learn more about their capabilities. In particular, read about <code>showCache</code>, <code>clearCache</code> and the argument <code>userTags</code>, which allow consulting and deleting cached files.</p>
<p><strong>/!\ ATTENTION /!\</strong></p>
<p><em><code>Cache</code> does not deal well with the <code>apply</code> family of functions, which is why we used <code>Map</code> (instead of <code>mapply</code>) to iteratively apply <code>prepInputs</code> to several climate layer URLs.</em></p>
</section><section id="implicit-caching-of-events" class="level3" data-number="2.4.2"><h3 data-number="2.4.2" class="anchored" data-anchor-id="implicit-caching-of-events">
<span class="header-section-number">2.4.2</span> Implicit caching of events</h3>
<p><code>SpaDES</code> offers implicit caching of events via the global parameter <code>.useCache</code>, which comes in the template modules generated by <code>newModule</code>. We call this “implicit” caching, because the developer does not need to add any caching mechanisms to the module code. <code>SpaDES</code> automatically reads the value of the <code>.useCache</code> parameter and activates caching in the module accordingly.</p>
<p>This parameter can be used to cache (or not) all or some module events (in their entirety). In our example, we cached have not cached events but passing <code>.useCache = ".inputObjects"</code> or <code>.useCache = "init"</code> would cache these events.</p>
<p>Notice how loading cached events (last line below) produces a slightly different message from loading other cached operations (second line below):</p>
<pre><code>Mar05 19:58:34 spcsbn 1 speciesAbundanceData init 1
Mar05 19:58:34 spcsbn ...(Object to retrieve (bffbc48cc055c846.rds)) 
Mar05 19:58:35 spcsbn loaded cached copy of init event in speciesAbundanceData module.</code></pre>
<p>We have noted that <code>terra</code> objects have issues with caching due to the fact that they rely on pointers. This is a behaviour that we started observing in September 2022 and may be resolved by <code>terra</code> developers in the future.</p>
</section><section id="controlling-caching-without-changing-module-code" class="level3" data-number="2.4.3"><h3 data-number="2.4.3" class="anchored" data-anchor-id="controlling-caching-without-changing-module-code">
<span class="header-section-number">2.4.3</span> Controlling caching without changing module code</h3>
<p>In addition to the , which controls caching at the module level.</p>
<p>The user can turn caching on/off without caching module code via three different mechanisms:</p>
<ul>
<li><p>via the <code>.useCache</code> parameter – as explained above (<a href="#implicit-caching-of-events">Implicit caching of events</a>), setting this parameter controls event caching inside a module;</p></li>
<li><p>via <code>options("reproducible.useCache")</code> – setting this option to <code>TRUE</code> or <code>FALSE</code> in the global environment (<code>.GlobalEnv</code>) will affect <em>all</em> caching (inside and outside <code>SpaDES</code> modules and the simulation);</p></li>
<li><p>via the argument <code>spades(.useCache = ...)</code> – this argument behaves in the same way as the <code>.useCache</code> module parameter, but supersedes it across <em>all</em> modules (i.e.&nbsp;if <code>spades(..., .useCache = FALSE)</code>, caching will be turned off even if a module’s <code>.useCache</code> is <code>TRUE</code>).</p></li>
</ul>
<hr></section></section><section id="best-practices" class="level2" data-number="2.5"><h2 data-number="2.5" class="anchored" data-anchor-id="best-practices">
<span class="header-section-number">2.5</span> Best practices</h2>
<section id="reproducible-package-installation" class="level3" data-number="2.5.1"><h3 data-number="2.5.1" class="anchored" data-anchor-id="reproducible-package-installation">
<span class="header-section-number">2.5.1</span> Reproducible package installation</h3>
<p>When sharing code, it is good practice to provide other users with a list of necessary packages (e.g.&nbsp;by listing the sequence of <code>library</code> calls at the start of a script). We go a step further and advise users to provide code that automatically installs all necessary packages at the start of their controller script. In addition all modules should contain a full list of packages that they depend on, and any particular versions necessary. If <code>options("spades.useRequire")</code> is set to <code>TRUE</code> (the default), <code>SpaDES</code> will automatically attempt to install any packages listed across all modules if they are not installed in <code><a href="https://rdrr.io/r/base/libPaths.html">.libPaths()</a></code>, or if the installed version (or branch if installing from GitHub) does not correspond to what is listed in the module <code>.R</code> script. Users can also use <code><a href="https://Require.predictiveecology.org/reference/pkgSnapshot.html">Require::pkgSnapshot()</a></code> to save a list of installed packages that can be used later by <code>Require</code> to install all necessary packages in another machine (see example below).</p>
<p>Please beware that package installation should be done as much as possible from a clean R session especially in the context of a <code>SpaDES</code>-based project, where each module can potentially have many different dependencies, which have dependencies of their own (see, for instance, how we delayed package loading until after all modules were in place and had their dependencies checked in <code>Part2_SDMs.R</code>)</p>
<div class="cell" data-hash="Part2_SDMs_cache/html/pkgSnapshot_94f4d5a5f59f3f6418e561f190985d7a">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">Require</span><span class="fu">::</span><span class="fu"><a href="https://Require.predictiveecology.org/reference/pkgSnapshot.html">pkgSnapshot</a></span><span class="op">(</span><span class="st">"pkgsnapshot.txt"</span>, libPaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>  <span class="co">## you should make sure the right .libPath is chosen</span></span>
<span></span>
<span><span class="co">## on another machine:</span></span>
<span><span class="fu">Require</span><span class="fu">::</span><span class="fu"><a href="https://Require.predictiveecology.org/reference/Require.html">Require</a></span><span class="op">(</span>packageVersionFile <span class="op">=</span> <span class="st">"pkgsnapshot.txt"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## See ?Require::pkgSnapshot() for more examples.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="protect-yourself-and-others-from-common-mistakesproblems" class="level3" data-number="2.5.2"><h3 data-number="2.5.2" class="anchored" data-anchor-id="protect-yourself-and-others-from-common-mistakesproblems">
<span class="header-section-number">2.5.2</span> Protect yourself and others from common mistakes/problems</h3>
<p>A developer should put in place code checks, warnings and messages that protect and warn the user against common mistakes or issues. Some of these fall in the category of <em>code assertions</em> – small tests that verify a snippet of code. More complex tests that assess whether the module (or a group of modules) is producing expected results for, e.g., an ecological point of view fall in the category of <em>integration tests</em>. Here, we only talk about code assertions.</p>
<p>A common assertion is to verify that input format and class conform to what the function expects. If this is not the case, the developer may add a mechanism to correct the faulty inputs (potentially with a warning or message telling the user it did so) or simply stop the computations with a meaningful error. We provide two examples in the <code>climateData</code> module, where the <code>climateInit</code> function checks whether the bioclimatic variable names are consistent between the baseline and projected climate data, and whether their raster layers match.</p>
<p>Other assertions can prevent undesirable function behaviours, such as the <code>if</code> statement protecting the <code>newModule</code> call in <code>Part2_SDMs.R</code>, or warn the user that something is missing early on, such as the check for <code>studyAreaRas</code> existence in the <code>.inputObjects</code> of the data modules).</p>
<p>Bear in mind that these are just examples assertions and integration tests are as diverse as the code they test.</p>
</section><section id="readable-code" class="level3" data-number="2.5.3"><h3 data-number="2.5.3" class="anchored" data-anchor-id="readable-code">
<span class="header-section-number">2.5.3</span> Readable code</h3>
<p>There are several guides on how to write reader-friendly code. Even if the developer is forever the sole reader of their own code, there are benefits to writing readable code. First, working on it is less tiresome. Second, we quickly forget why we wrote code in a certain away. Code that is well documented and readable is easier to “come back to” and adapt.</p>
<p>We follow many of the <a href="https://adv-r.had.co.nz/Style.html">recommendations by Hadley Wickham</a>, and highlight below those that we find particularly important:</p>
<ul>
<li><p>spacing around operators;</p></li>
<li><p>spacing before left parenthesis, except in a function call;</p></li>
<li><p>adding curly braces after <code>if</code>, <code>else</code>, <code>for</code> and <code>function</code>, unless they are very short statements;</p></li>
<li><p>thoroughly commenting the code;</p></li>
<li><p>naming functions meaningfully and avoiding to re-use function names (e.g.&nbsp;avoid <code>c &lt;- function (...) {}</code>, as <code>c</code> is already a <code>base</code> function).</p></li>
</ul>
<p>You can automatically cleanup and format your code using the <code>styler</code> package. This package provides an Rstudio addin to easily style a block of selected code, or an entire file.</p>
</section><section id="module-documentation-module-.rmd" class="level3" data-number="2.5.4"><h3 data-number="2.5.4" class="anchored" data-anchor-id="module-documentation-module-.rmd">
<span class="header-section-number">2.5.4</span> Module documentation – module <code>.Rmd</code>
</h3>
<p>When modules are created using <code>newModule</code>, this function provides a template module <code>.Rmd</code> file that is meant to document the module. The template suggests a few key sections that should be part of any module’s documentation. Notably, an overview of the module and of its inputs, parameters, outputs and general event flow, together with more in-depth descriptions of each of these sections.</p>
<p>The documentation may also contain reproducible examples of how a module can be used, although this is not always relevant. For instance, data modules are often meaningless without downstream modules that use their outputs.</p>
<p>We invite the reader to see the manual of our forest landscape simulation model <a href="https://htmlpreview.github.io/?https://github.com/PredictiveEcology/Biomass_core/blob/development/Biomass_core.html">LandR <em>Biomass_core</em></a>, as an example of how we document some of our <code>SpaDES</code> modules.</p>
</section><section id="coding-for-the-future" class="level3" data-number="2.5.5"><h3 data-number="2.5.5" class="anchored" data-anchor-id="coding-for-the-future">
<span class="header-section-number">2.5.5</span> Coding for the future</h3>
<p>We often make coding decisions that we regret a few months down the line. This is why as module developers, it is a good idea to think about other possible applications of a module or potential expansion avenues. For instance, trying to imagine if the module can be scaled up or transferred to different study areas, may influence the format of expected inputs and of outputs. In our example, we exported the same type of information (species % cover and climate data) as raster layers and as tables, because we could foresee that the tables could be used to store several projections in a more compact format.</p>
</section><section id="transparent-models" class="level3" data-number="2.5.6"><h3 data-number="2.5.6" class="anchored" data-anchor-id="transparent-models">
<span class="header-section-number">2.5.6</span> Transparent models</h3>
<p>Model transparency is not only about using open source code and making it available. Providing easy access to model data, parameters and outputs is also important. For instance, in our example we deliberately exported the fitted statistical model <code>sdmOut</code>, data (<code>sdmData</code>) and evaluation statistics (<code>evalOut</code>) so that they can be more easily inspected by the user, without needing to “dive in” the code.</p>
<p><code>SpaDES</code> also offers the ability to save any objects that are exported to the <code>simList</code> object <em>without having to change module code</em>. To do so, the user passes a <code>data.frame</code> of object names and (potentially) the simulation times when they should be saved to the <code>simInit(outputs = ...)</code> argument. Because objects are saved as <code>.rds</code> files by default, any object class can be saved to disk (see <code>?outputs</code> for more information).</p>
<hr></section></section><section id="additional-notes" class="level2" data-number="2.6"><h2 data-number="2.6" class="anchored" data-anchor-id="additional-notes">
<span class="header-section-number">2.6</span> Additional notes</h2>
<p><code>SpaDES</code> is an extremely powerful family of R packages, whose potential goes well beyond what has been discussed here. We recommend going to the <a href="https://predictiveecology.org/"><code>SpaDES</code> webpage</a> to find out more about the <code>SpaDES</code> R modelling platform, upcoming workshops and publications. See also the <a href="https://https://github.com/PredictiveEcology/">Predictive Ecology Github repository</a> for a list of all available <code>SpaDES</code> modules and <code>SpaDES</code>-related packages that we maintain.</p>
<p>We wish to acknowledge the World Climate Research Programme, which coordinated and promoted CMIP6, and thank the climate modelling groups for producing and making available their model output, the Earth System Grid Federation (ESGF) for archiving the data and providing access, and WorldClim for downscaling and sharing climate projections and preparing bioclimatic variables.</p>
<hr>
<center>
<strong>Happy SpaDESing!</strong>
</center>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./Part1_DummyModel.html" class="pagination-link  aria-label=" with="" a="" dummy="" ecological="" model="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducing <code>SpaDES</code> with a dummy ecological model</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./References.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>SpaDES For Dummies was written by Ceres Barros, Eliot McIntire, Tati Michelleti and Alex Chubaty.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>